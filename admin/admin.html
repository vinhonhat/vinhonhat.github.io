<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Qu·∫£n Tr·ªã B√†i Vi·∫øt | Vinh ·ªü Nh·∫≠t</title>
    
    <!-- T·∫£i CSS t·ª´ trang ch√≠nh ƒë·ªÉ ƒë·ªìng b·ªô giao di·ªán -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/style.css"> <!-- ƒê∆∞·ªùng d·∫´n CSS ch√≠nh c·ªßa b·∫°n -->
    <!-- üîπ Icon website (favicon) -->
    <link rel="icon" href="/img/logoQV.png" type="image/x-icon"> 
    <!-- T·∫£i TinyMCE (B·∫ÆT BU·ªòC: B·∫°n ph·∫£i t·∫£i v·ªÅ v√† ƒë·∫∑t v√†o th∆∞ m·ª•c /admin/tinymce/) -->
    <script src="/admin/tinymce/tinymce.min.js" referrerpolicy="origin"></script>

    <style>
        body { background-color: #FBF7F0; font-family: 'Inter', sans-serif; }
        .tox-tinymce { min-height: 500px !important; border-radius: 0.375rem; }
        #previewModal { background-color: rgba(0, 0, 0, 0.5); }
    </style>
</head>
<body class="bg-[#FBF7F0]">
    
    <main class="max-w-6xl mx-auto px-4 mt-8">
        <h1 class="text-3xl font-bold text-gray-800 border-l-4 border-yellow-600 pl-4 mb-6">Mini CMS - Qu·∫£n Tr·ªã B√†i Vi·∫øt</h1>

        <div class="grid grid-cols-1 gap-8">
            
            <!-- FORM CH·ªàNH S·ª¨A (ƒê√£ chuy·ªÉn ra gi·ªØa) -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                
                <!-- 1. CH·ªåN B√ÄI VI·∫æT -->
                <div class="mb-6">
                    <label for="postSelector" class="block text-sm font-medium text-gray-700 mb-2">Ch·ªçn b√†i vi·∫øt ƒë·ªÉ ch·ªânh s·ª≠a:</label>
                    <select id="postSelector" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500">
                        <option value="">-- Vui l√≤ng ch·ªçn m·ªôt b√†i vi·∫øt --</option>
                        <option value="__NEW__" class="font-bold text-green-600">-- T·∫†O B√ÄI VI·∫æT M·ªöI --</option>
                    </select>
                </div>

                <!-- 2. FORM METADATA (·∫®N KHI CH∆ØA CH·ªåN B√ÄI) -->
                <form id="editForm" class="space-y-4" style="display: none;">
                    
                    <!-- *** C·∫¨P NH·∫¨T: Th√™m ch·ªçn ƒë∆∞·ªùng d·∫´n *** -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="basePathSelector" class="block text-sm font-medium text-gray-700">Ch·ªçn th∆∞ m·ª•c l∆∞u</label>
                            <select id="basePathSelector" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="/pages/bai-viet/">B√†i vi·∫øt [/pages/bai-viet/]</option>
                                <option value="/pages/video/">Video [/pages/video/]</option>
                                <option value="/pages/rakuten/">Rakuten [/pages/rakuten/]</option>
                                <!-- Th√™m c√°c th∆∞ m·ª•c kh√°c c·ªßa b·∫°n ·ªü ƒë√¢y n·∫øu c·∫ßn -->
                            </select>
                        </div>
                        <div>
                            <!-- *** C·∫¨P NH·∫¨T: ƒê·ªïi t·ª´ "ƒê∆∞·ªùng d·∫´n file" sang "T√™n file" *** -->
                            <label for="postFilename" class="block text-sm font-medium text-gray-700">T√™n file (v√≠ d·ª•: ten-bai-viet.html)</label>
                            <input type="text" id="postFilename" placeholder="ten-bai-viet.html" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" required>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="postId" class="block text-sm font-medium text-gray-700">ID B√†i Vi·∫øt (T·ª± ƒë·ªông, duy nh·∫•t)</label>
                            <input type="text" id="postId" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" required>
                        </div>
                        <div>
                            <label for="postDate" class="block text-sm font-medium text-gray-700">Ng√†y ƒëƒÉng (YYYY-MM-DD)</label>
                            <input type="date" id="postDate" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" required>
                        </div>
                    </div>
                    
                    <div>
                        <label for="postTitle" class="block text-sm font-medium text-gray-700">Ti√™u ƒë·ªÅ</label>
                        <input type="text" id="postTitle" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" required>
                    </div>

                    <div>
                        <label for="postSummary" class="block text-sm font-medium text-gray-700">T√≥m t·∫Øt (Summary) (D√πng cho SEO)</label>
                        <textarea id="postSummary" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"></textarea>
                    </div>

                    <div>
                        <label for="postImageUrl" class="block text-sm font-medium text-gray-700">Link ·∫£nh b√¨a (ImageUrl) (D√πng cho SEO)</label>
                        <input type="text" id="postImageUrl" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="postType" class="block text-sm font-medium text-gray-700">Lo·∫°i (type)</label>
                            <input type="text" id="postType" placeholder="guide, review, video" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="postCategory" class="block text-sm font-medium text-gray-700">Danh m·ª•c (category)</label>
                            <input type="text" id="postCategory" placeholder="sim, bank, life" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="postTags" class="block text-sm font-medium text-gray-700">Tags (c√°ch nhau b·∫±ng d·∫•u ph·∫©y)</label>
                            <input type="text" id="postTags" placeholder="tag1, tag2, tag3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                    </div>
                    
                     <div>
                        <label for="postFeatured" class="block text-sm font-medium text-gray-700">N·ªïi b·∫≠t (featured)</label>
                        <select id="postFeatured" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            <option value="false">Kh√¥ng</option>
                            <option value="true">C√≥</option>
                        </select>
                    </div>

                    <!-- 3. TR√åNH SO·∫†N TH·∫¢O TINYMCE -->
                    <div class="mt-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">N·ªôi dung chi ti·∫øt (contentHtml)</label>
                        <textarea id="contentEditor"></textarea>
                    </div>

                    <!-- 4. N√öT B·∫§M -->
                    <div class="flex flex-wrap justify-end gap-4 pt-4">
                        <button type="button" id="previewButton" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-full transition-all duration-300 hover:bg-blue-700 shadow-md">
                            Xem tr∆∞·ªõc (Full)
                        </button>
                        <button type="button" id="saveButton" class="bg-yellow-600 text-white font-semibold py-2 px-6 rounded-full transition-all duration-300 hover:bg-yellow-700 shadow-md">
                            C·∫≠p nh·∫≠t JSON
                        </button>
                        <button type="button" id="generateHtmlButton" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-full transition-all duration-300 hover:bg-green-700 shadow-md">
                            T·∫°o & T·∫£i File HTML
                        </button>
                    </div>

                </form>
            </div>

            <!-- H∆Ø·ªöNG D·∫™N & OUTPUT (N·∫±m b√™n d∆∞·ªõi) -->
            <div class="space-y-6">
                
                <div id="guideBox" class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold text-gray-800 border-l-4 border-yellow-600 pl-4 mb-4">H∆∞·ªõng d·∫´n & Gi·∫£i ƒë√°p</h2>
                    <dl class="space-y-4 text-gray-700">
                        <div>
                            <dt class="font-semibold">Q: T·∫°i sao ph·∫£i "C·∫≠p nh·∫≠t JSON"?</dt>
                            <dd class="text-sm pl-2 border-l-2 border-gray-200 ml-2 mt-1">
                                A: V√¨ website c·ªßa b·∫°n l√† <strong>web tƒ©nh</strong> (tr√™n GitHub Pages), tr√¨nh duy·ªát kh√¥ng th·ªÉ t·ª± ƒë·ªông ghi file. N√∫t n√†y t·∫°o ra n·ªôi dung file <code>data/posts.json</code> m·ªõi. B·∫°n ph·∫£i <strong>sao ch√©p</strong> v√† <strong>d√°n ƒë√®</strong> n·ªôi dung ƒë√≥ v√†o file trong code c·ªßa m√¨nh.
                            </dd>
                        </div>
                        <div>
                            <dt class="font-semibold">Q: L√†m sao ƒë·ªÉ th√™m nhi·ªÅu "Tags"?</dt>
                            <dd class="text-sm pl-2 border-l-2 border-gray-200 ml-2 mt-1">
                                A: B·∫°n ch·ªâ c·∫ßn nh·∫≠p v√†o √¥ <strong>"Tags"</strong>, c√°c tag kh√°c nhau ƒë∆∞·ª£c ngƒÉn c√°ch b·∫±ng <strong>d·∫•u ph·∫©y</strong> (v√≠ d·ª•: <code>sim, linemo, huong-dan</code>).
                            </dd>
                        </div>
                        <div>
                            <dt class="font-semibold">Q: "ƒê∆∞·ªùng d·∫´n file" ho·∫°t ƒë·ªông th·∫ø n√†o?</dt>
                            <dd class="text-sm pl-2 border-l-2 border-gray-200 ml-2 mt-1">
                                A: Gi·ªù ƒë√¢y b·∫°n ch·ªâ c·∫ßn <strong>ch·ªçn th∆∞ m·ª•c</strong> v√† <strong>g√µ t√™n file</strong>. H·ªá th·ªëng s·∫Ω t·ª± gh√©p l·∫°i. Khi nh·∫•n <strong>"T·∫£i File HTML"</strong>, file s·∫Ω ƒë∆∞·ª£c t·∫£i v·ªÅ v·ªõi ƒë√∫ng t√™n ƒë√≥. B·∫°n c·∫ßn <strong>t·ª± tay di chuy·ªÉn file</strong> v√†o ƒë√∫ng th∆∞ m·ª•c ƒë√£ ch·ªçn trong d·ª± √°n c·ªßa m√¨nh khi c·ª≠a s·ªï "Save As" hi·ªán ra.
                            </dd>
                        </div>
                    </dl>
                </div>

                <!-- N∆°i hi·ªÉn th·ªã link t·∫£i file HTML -->
                <div id="htmlOutputContainer" class="bg-white p-6 rounded-lg shadow-md" style="display: none;">
                    <h2 class="text-xl font-bold text-gray-800 border-l-4 border-green-600 pl-4 mb-4">File HTML ƒë√£ s·∫µn s√†ng</h2>
                    <p class="text-gray-700 mb-3">Nh·∫•n v√†o link b√™n d∆∞·ªõi ƒë·ªÉ t·∫£i file v·ªÅ:</p>
                    <a id="downloadHtmlLink" class="text-lg font-bold text-green-700 underline hover:text-green-800"></a>
                    <p class="text-xs text-gray-500 mt-2">H√£y l∆∞u file n√†y v√†o ƒë√∫ng ƒë∆∞·ªùng d·∫´n b·∫°n ƒë√£ khai b√°o (v√≠ d·ª•: <code>pages/bai-viet/</code>).</p>
                </div>
                
                <!-- N∆°i hi·ªÉn th·ªã JSON -->
                <div id="jsonOutputContainer" class="bg-white p-6 rounded-lg shadow-md" style="display: none;">
                    <h2 class="text-xl font-bold text-gray-800 border-l-4 border-red-600 pl-4 mb-4">D·ªØ li·ªáu JSON ƒë·ªÉ l∆∞u</h2>
                    <p class="text-sm text-red-600 mb-2">Sao ch√©p n·ªôi dung n√†y v√† d√°n ƒë√® v√†o file <code>data/posts.json</code>.</p>
                    <textarea id="jsonOutput" rows="15" class="w-full p-2 border border-gray-300 rounded-md bg-gray-50 font-mono text-sm" readonly></textarea>
                </div>
            </div>

        </div>
    </main>
    
    <!-- MODAL XEM TR∆Ø·ªöC (Kh√¥ng ƒë·ªïi) -->
    <div id="previewModal" class="fixed inset-0 z-50 flex items-center justify-center p-4" style="display: none;">
    <div class="bg-white w-full max-w-6xl h-[90vh] rounded-lg shadow-xl flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-bold">B·∫£n xem tr∆∞·ªõc n·ªôi dung</h2>
                <button id="closePreview" class="text-2xl text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto">
                <iframe id="previewIframe" class="w-full h-full border-0"></iframe>
            </div>
        </div>
    </div>


    <!-- JAVASCRIPT C·ª¶A TRANG CMS -->
    <script src="/js/config.js" type="module"></script>

    <script type="module">
        import { SITE_CONFIG } from '/js/config.js';

        // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ trang
        document.title = `Trang Qu·∫£n Tr·ªã | ${SITE_CONFIG.titleSuffix || 'Vinh ·ªü Nh·∫≠t'}`;

        // --- C√ÅC BI·∫æN TO√ÄN C·ª§C ---
        let allPostsData = []; 
        let postTemplateHtml = ''; // L∆∞u tr·ªØ file template.html
        const postSelector = document.getElementById('postSelector');
        const editForm = document.getElementById('editForm');
        
        // Form fields
        const basePathSelector = document.getElementById('basePathSelector');
        const postFilename = document.getElementById('postFilename');
        const postId = document.getElementById('postId');
        const postDate = document.getElementById('postDate');
        const postTitle = document.getElementById('postTitle');
        const postSummary = document.getElementById('postSummary');
        const postImageUrl = document.getElementById('postImageUrl');
        const postType = document.getElementById('postType');
        const postCategory = document.getElementById('postCategory');
        const postTags = document.getElementById('postTags');
        const postFeatured = document.getElementById('postFeatured');

        // Buttons
        const saveButton = document.getElementById('saveButton');
        const previewButton = document.getElementById('previewButton');
        const generateHtmlButton = document.getElementById('generateHtmlButton');
        
        // Output
        const jsonOutputContainer = document.getElementById('jsonOutputContainer');
        const jsonOutput = document.getElementById('jsonOutput');
        const htmlOutputContainer = document.getElementById('htmlOutputContainer');
        const downloadHtmlLink = document.getElementById('downloadHtmlLink');

        // Preview Modal
        const previewModal = document.getElementById('previewModal');
        const closePreview = document.getElementById('closePreview');
        const previewIframe = document.getElementById('previewIframe');

        const guideBox = document.getElementById('guideBox');


        // --- KI·ªÇM TRA TINYMCE ---
        if (typeof tinymce === 'undefined') {
            alert('L·ªñI: Kh√¥ng th·ªÉ t·∫£i TinyMCE. H√£y ƒë·∫£m b·∫£o b·∫°n ƒë√£ t·∫£i v·ªÅ v√† ƒë·∫∑t v√†o th∆∞ m·ª•c /admin/tinymce/ theo h∆∞·ªõng d·∫´n.');
            throw new Error('TinyMCE not found.'); 
        }

        // --- KH·ªûI T·∫†O TINYMCE ---
        tinymce.init({
            selector: '#contentEditor',
            plugins: 'preview importcss searchreplace autolink autosave save directionality code visualblocks visualchars fullscreen image link media template codesample table charmap pagebreak nonbreaking anchor insertdatetime advlist lists wordcount help charmap quickbars emoticons',
            menubar: 'file edit view insert format tools table help',
            toolbar: 'undo redo | bold italic underline strikethrough | fontfamily fontsize blocks | alignleft aligncenter alignright alignjustify | outdent indent |  numlist bullist | forecolor backcolor removeformat | pagebreak | charmap emoticons | fullscreen  preview save print | insertfile image media template link anchor codesample | ltr rtl',
            image_advtab: true,
            importcss_append: true,
            content_css: ['https://cdn.tailwindcss.com', '/css/style.css'], 
            height: 600,
            image_caption: true,
            quickbars_selection_toolbar: 'bold italic | quicklink h2 h3 blockquote quickimage quicktable',
            toolbar_mode: 'sliding',
            contextmenu: 'link image table',
            skin: 'oxide',
            content_style: 'body { font-family:Inter,Helvetica,Arial,sans-serif; font-size:16px }',
            
            setup: (editor) => {
                editor.on('init', () => {
                    loadInitialData();
                });
            }
        });

        // --- T·∫¢I D·ªÆ LI·ªÜU BAN ƒê·∫¶U (Data v√† Template) ---
        async function loadInitialData() {
            try {
                // T·∫£i song song 2 file
                const [postsResponse, templateResponse] = await Promise.all([
                    fetch('/data/posts.json?t=' + new Date().getTime()),
                    fetch('/admin/post-template.html?t=' + new Date().getTime()) // T·∫£i file template m·ªõi
                ]);

                if (!postsResponse.ok) throw new Error(`Kh√¥ng th·ªÉ t·∫£i posts.json: ${postsResponse.statusText}`);
                if (!templateResponse.ok) throw new Error(`Kh√¥ng th·ªÉ t·∫£i post-template.html: ${templateResponse.statusText}`);

                allPostsData = await postsResponse.json();
                postTemplateHtml = await templateResponse.text(); // L∆∞u file template v√†o bi·∫øn
                
                allPostsData.sort((a, b) => new Date(b.date) - new Date(a.date));
                populateSelector();
                
                console.log('CMS ƒë√£ t·∫£i xong data v√† template.');

            } catch (error) {
                console.error('L·ªói khi t·∫£i d·ªØ li·ªáu:', error);
                alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu b√†i vi·∫øt ho·∫∑c file template. Vui l√≤ng ki·ªÉm tra console.');
            }
        }

        // --- ƒê∆ØA D·ªÆ LI·ªÜU V√ÄO DROPDOWN ---
        function populateSelector() {
            while (postSelector.options.length > 2) postSelector.remove(2);
            allPostsData.forEach(post => {
                const option = document.createElement('option');
                option.value = post.id;
                option.textContent = `${post.title} (${post.date})`;
                postSelector.appendChild(option);
            });
        }

        // --- X·ª¨ L√ù KHI CH·ªåN B√ÄI VI·∫æT ---
        postSelector.addEventListener('change', () => {
            const selectedId = postSelector.value;
            
            if (!selectedId) {
                editForm.style.display = 'none';
                guideBox.style.display = 'block'; 
                return;
            }

            const postData = (selectedId === '__NEW__') ? null : allPostsData.find(p => p.id === selectedId);
            loadPostData(postData);
            
            editForm.style.display = 'block'; 
            guideBox.style.display = 'none'; 
            jsonOutputContainer.style.display = 'none';
            htmlOutputContainer.style.display = 'none';
        });

        // --- T·∫¢I D·ªÆ LI·ªÜU B√ÄI VI·∫æT L√äN FORM ---
        function loadPostData(post) {
            if (post) {
                // Ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
                postId.value = post.id;
                postId.readOnly = true;
                postDate.value = post.date;
                postTitle.value = post.title;
                postSummary.value = post.summary;
                postImageUrl.value = post.imageUrl;
                postType.value = post.type;
                postCategory.value = post.category;
                postTags.value = post.tags.join(', ');
                postFeatured.value = post.featured.toString();
                tinymce.get('contentEditor').setContent(post.contentHtml || '');

                // *** C·∫¨P NH·∫¨T: T√°ch link th√†nh base path v√† filename ***
                const lastSlashIndex = post.link.lastIndexOf('/');
                if (lastSlashIndex > -1) {
                    basePathSelector.value = post.link.substring(0, lastSlashIndex + 1);
                    postFilename.value = post.link.substring(lastSlashIndex + 1);
                } else {
                    basePathSelector.value = '/pages/bai-viet/'; // M·∫∑c ƒë·ªãnh
                    postFilename.value = post.link; // Tr∆∞·ªùng h·ª£p c≈© kh√¥ng c√≥ /
                }

            } else {
                // Ch·∫ø ƒë·ªô t·∫°o m·ªõi
                const now = new Date();
                const dateSlug = now.toISOString().slice(0, 10).replace(/-/g, ''); // YYYYMMDD
                const timeSlug = now.toTimeString().slice(0, 5).replace(':', ''); // HHMM
                
                postId.value = `post-${dateSlug}-${timeSlug}`; 
                postId.readOnly = false;
                postDate.value = now.toISOString().slice(0, 10);
                postTitle.value = 'Ti√™u ƒë·ªÅ b√†i vi·∫øt m·ªõi';
                postSummary.value = 'T√≥m t·∫Øt b√†i vi·∫øt m·ªõi (d√πng cho SEO)';
                postImageUrl.value = 'https://placehold.co/1200x630/FBF7F0/718096?text=Anh+SEO';
                postType.value = 'guide';
                postCategory.value = 'sim';
                postTags.value = '';
                postFeatured.value = 'false';
                tinymce.get('contentEditor').setContent('<p>B·∫Øt ƒë·∫ßu vi·∫øt n·ªôi dung ·ªü ƒë√¢y...</p>');
                
                // *** C·∫¨P NH·∫¨T: ƒê·∫∑t gi√° tr·ªã m·∫∑c ƒë·ªãnh cho 2 √¥ m·ªõi ***
                basePathSelector.value = '/pages/bai-viet/'; // M·∫∑c ƒë·ªãnh
                postFilename.value = `ten-bai-viet-${dateSlug}-${timeSlug}.html`; // G·ª£i √Ω t√™n file
            }
        }

        // --- H√ÄM L·∫§Y D·ªÆ LI·ªÜU T·ª™ FORM ---
        function getPostObjectFromForm() {
            if (!validateForm()) {
                alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc (ID, Ng√†y, Ti√™u ƒë·ªÅ, T√™n file).');
                return null;
            }
            
            // *** C·∫¨P NH·∫¨T: Gh√©p base path v√† filename ƒë·ªÉ t·∫°o link ***
            const basePath = basePathSelector.value;
            const filename = postFilename.value.trim();
            const fullLink = basePath + filename;

            return {
                id: postId.value.trim(),
                date: postDate.value,
                title: postTitle.value.trim(),
                summary: postSummary.value.trim(),
                imageUrl: postImageUrl.value.trim(),
                type: postType.value.trim(),
                category: postCategory.value.trim(),
                tags: postTags.value.split(',').map(tag => tag.trim()).filter(Boolean),
                link: fullLink, // D√πng link ƒë√£ gh√©p
                featured: postFeatured.value === 'true',
                contentHtml: tinymce.get('contentEditor').getContent()
            };
        }
        
        function validateForm() {
            // *** C·∫¨P NH·∫¨T: Ki·ªÉm tra postFilename thay v√¨ postLink ***
            return postId.value.trim() && postDate.value && postTitle.value.trim() && postFilename.value.trim();
        }
        
        // --- H√ÄM T·∫†O N·ªòI DUNG HTML HO√ÄN CH·ªàNH (D√πng cho c·∫£ Preview v√† T·∫£i v·ªÅ) ---
        function generateFullHtml(post) {
            if (!postTemplateHtml) {
                alert('L·ªói: Ch∆∞a t·∫£i ƒë∆∞·ª£c file template. Vui l√≤ng th·ª≠ t·∫£i l·∫°i trang.');
                return null;
            }

            const formattedDate = new Date(post.date).toLocaleString('vi-VN', {
                day: 'numeric', month: 'long', year: 'numeric'
            });
            
            let finalHtml = postTemplateHtml;
            finalHtml = finalHtml.replace(/{{POST_TITLE}}/g, post.title);
            finalHtml = finalHtml.replace(/{{META_DESCRIPTION}}/g, post.summary.replace(/"/g, '&quot;'));
            finalHtml = finalHtml.replace(/{{META_IMAGE_URL}}/g, post.imageUrl);
            finalHtml = finalHtml.replace(/{{POST_LINK}}/g, post.link);
            finalHtml = finalHtml.replace(/{{ARTICLE_TITLE}}/g, post.title);
            finalHtml = finalHtml.replace(/{{ARTICLE_DATE}}/g, formattedDate);
            finalHtml = finalHtml.replace(/{{ARTICLE_CONTENT}}/g, post.contentHtml);
            
            return finalHtml;
        }


        // --- X·ª¨ L√ù N√öT "C·∫¨P NH·∫¨T JSON" ---
        saveButton.addEventListener('click', () => {
            const savedPost = getPostObjectFromForm();
            if (!savedPost) return;

            const existingPostIndex = allPostsData.findIndex(p => p.id === savedPost.id);
            if (existingPostIndex > -1) {
                allPostsData[existingPostIndex] = savedPost;
            } else {
                allPostsData.push(savedPost);
            }
            allPostsData.sort((a, b) => new Date(b.date) - new Date(a.date));

            jsonOutput.value = JSON.stringify(allPostsData, null, 2); 
            jsonOutputContainer.style.display = 'block';
            
            populateSelector();
            postSelector.value = savedPost.id;

            alert('ƒê√£ t·∫°o xong JSON! Vui l√≤ng sao ch√©p n·ªôi dung v√† d√°n v√†o file data/posts.json.');
        });
        
        // --- X·ª¨ L√ù N√öT "T·∫†O & T·∫¢I FILE HTML" ---
        generateHtmlButton.addEventListener('click', () => {
            const post = getPostObjectFromForm();
            if (!post) return;

            const finalHtml = generateFullHtml(post);
            if (!finalHtml) return;
            
            const blob = new Blob([finalHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            // *** C·∫¨P NH·∫¨T: D√πng postFilename l√†m t√™n file ***
            const fileName = postFilename.value.trim() || 'bai-viet.html';
            
            downloadHtmlLink.href = url;
            downloadHtmlLink.download = fileName; 
            downloadHtmlLink.textContent = `T·∫£i v·ªÅ: ${fileName}`;
            htmlOutputContainer.style.display = 'block';
            
            alert('ƒê√£ t·∫°o file HTML! Nh·∫•n v√†o link v·ª´a xu·∫•t hi·ªán ƒë·ªÉ t·∫£i v·ªÅ.');
        });

        // --- *** S·ª¨A L·ªñI: X·ª¨ L√ù XEM TR∆Ø·ªöC (Preview) *** ---
        // S·ª≠ d·ª•ng l·∫°i file template ƒë√£ t·∫£i, kh√¥ng inject script
        previewButton.addEventListener('click', () => {
            const post = getPostObjectFromForm();
            if (!post) return;
            
            // 1. T·∫°o HTML t·ª´ template
            let finalHtml = generateFullHtml(post);
            if (!finalHtml) return;

            // 2. T·∫£i n·ªôi dung v√†o iframe
            // Kh√¥ng c·∫ßn ch√®n script n·ªØa v√¨ post-template.html ƒë√£ c√≥ s·∫µn
            previewIframe.srcdoc = finalHtml;
            previewModal.style.display = 'flex';
        });

        closePreview.addEventListener('click', () => {
            previewModal.style.display = 'none';
            previewIframe.srcdoc = '';
        });
        // --- H√ÄM CHUY·ªÇN TI√äU ƒê·ªÄ TH√ÄNH KH√îNG D·∫§U & K√ù T·ª∞ H·ª¢P L·ªÜ ---
function toSlug(str) {
    return str
        .normalize('NFD') // t√°ch d·∫•u
        .replace(/[\u0300-\u036f]/g, '') // xo√° d·∫•u
        .toLowerCase()
        .replace(/[^a-z0-9\s-]/g, '') // b·ªè k√Ω t·ª± ƒë·∫∑c bi·ªát
        .trim()
        .replace(/\s+/g, '-'); // kho·∫£ng tr·∫Øng ‚Üí g·∫°ch n·ªëi
}

// --- H√ÄM CH·ªà T·∫†O JSON CHO 1 B√ÄI VI·∫æT ---
function generateSinglePostJson(post) {
    // ch·ªâ format v·ª´a ƒë·ªß ƒë·ªÉ tags n·∫±m 1 d√≤ng
    const jsonString = JSON.stringify(post, null, 2)
        .replace(/\n\s+"tags": \[\s+/g, ' "tags": [')
        .replace(/\s+\],/g, '],');
    return jsonString;
}

// --- GHI ƒê√à N√öT "C·∫¨P NH·∫¨T JSON" ---
saveButton.addEventListener('click', () => {
    const savedPost = getPostObjectFromForm();
    if (!savedPost) return;

    // ‚úÖ T·ª± t·∫°o t√™n file n·∫øu ƒë·ªÉ tr·ªëng
    if (!postFilename.value.trim()) {
        const dateSlug = savedPost.date.replace(/-/g, '');
        const slug = toSlug(savedPost.title);
        savedPost.link = basePathSelector.value + `${slug}-${dateSlug}.html`;
        postFilename.value = `${slug}-${dateSlug}.html`;
    }

    // ‚úÖ N·∫øu b√†i c≈© v√† ng√†y ch∆∞a ch·ªânh ‚Üí gi·ªØ nguy√™n
    const existing = allPostsData.find(p => p.id === savedPost.id);
    if (existing) {
        if (existing.date && existing.date === postDate.defaultValue) {
            savedPost.date = existing.date;
        }
        Object.assign(existing, savedPost);
    } else {
        // b√†i m·ªõi ‚Üí t·ª± ƒë·ªông ng√†y h√¥m nay
        savedPost.date = new Date().toISOString().slice(0, 10);
        allPostsData.push(savedPost);
    }

    // --- Xu·∫•t JSON r√∫t g·ªçn ch·ªâ cho b√†i n√†y ---
    const shortJson = generateSinglePostJson(savedPost);
    jsonOutput.value = shortJson;
    jsonOutputContainer.style.display = 'block';
    htmlOutputContainer.style.display = 'none';
    populateSelector();
    postSelector.value = savedPost.id;

    alert('‚úÖ ƒê√£ t·∫°o JSON cho b√†i hi·ªán t·∫°i! H√£y copy ph·∫ßn n√†y v√† d√°n v√†o data/posts.json.');
});

    </script>
    
</body>
</html>

