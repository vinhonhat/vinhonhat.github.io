<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<title>Flappy Bird — Fullscreen</title>
<link rel="stylesheet" href="../css/style.css">
<script src="https://cdn.tailwindcss.com"></script>
<style>
  html,body { height:100%; margin:0; }
  body { background:#000; display:flex; flex-direction:column; min-height:100vh; }
  .game-shell { position:relative; width:100%; max-width:420px; margin:0 auto; flex:1; display:flex; align-items:center; justify-content:center; }
  #game-container { width:100%; height:calc(100vh - 16px); max-height:960px; max-width:560px; background:#87CEEB; position:relative; overflow:hidden; border-radius:10px; box-shadow:0 8px 30px rgba(0,0,0,.3); }
  canvas { display:block; width:100%; height:100%; touch-action:none; }
  .ui-overlay { position:absolute; top:12px; left:12px; z-index:50; display:flex; gap:8px; }
  .ui-overlay button { background:#f6ad55; border:none; padding:.5rem .75rem; border-radius:8px; font-weight:600; cursor:pointer; box-shadow:0 3px 8px rgba(0,0,0,.15); }
  .center-overlay { position:absolute; inset:0; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:40; pointer-events:auto; }
  .center-overlay h1 { color:white; font-size:28px; margin-bottom:.75rem; text-shadow:0 3px 8px rgba(0,0,0,.6); }
  .small-note { color:rgba(255,255,255,.9); font-size:14px; margin-top:.5rem; opacity:.95; }
  .score-top { position:absolute; top:18px; left:50%; transform:translateX(-50%); z-index:45; font-size:36px; color:white; text-shadow:0 2px 6px #000; }
  .footer-exit { position:absolute; bottom:14px; left:50%; transform:translateX(-50%); z-index:45; }
  .footer-exit button { background:rgba(0,0,0,.45); color:white; border:none; padding:8px 12px; border-radius:8px; }
</style>
</head>
<body>

<!-- Header (you can remove and use rakuten header instead) -->
<header class="bg-white shadow-sm py-3">
  <div class="container mx-auto px-4 flex justify-between items-center">
    <a href="../index.html" class="flex items-center space-x-2">
      <img src="../img/logo.png" class="h-10 w-10 rounded-full" alt="logo">
      <span class="hidden sm:block font-bold">Vinh ở Nhật</span>
    </a>
    <nav class="text-sm">
      <a href="../giaitri.html" class="text-gray-700 hover:text-yellow-600">Quay lại</a>
    </nav>
  </div>
</header>

<div class="game-shell">
  <div id="game-container" tabindex="0" aria-label="Flappy bird game container">
    <canvas id="gameCanvas"></canvas>

    <div class="ui-overlay">
      <button id="playBtn">Play</button>
      <button id="muteBtn">🔈</button>
      <button id="exitBtn">Thoát</button>
    </div>

    <div class="score-top" id="scoreDisplay" aria-hidden="true" style="display:none">0</div>

    <div class="center-overlay" id="startOverlay">
      <h1>Flappy Bird</h1>
      <button id="startScreenPlay" class="px-6 py-3 rounded-lg font-bold" style="background:#f6ad55;">Bắt đầu</button>
      <div class="small-note">Chạm / Click hoặc nhấn Space để nhảy</div>
    </div>

    <div class="footer-exit" id="gameOverOverlay" style="display:none">
      <div class="text-center text-white">
        <div id="gameOverText" style="font-weight:700; font-size:20px;"></div>
        <div style="margin-top:8px;">
          <button id="retryBtn" class="mr-2" style="background:#f6ad55; padding:.5rem .75rem; border-radius:8px;">Chơi lại</button>
          <button id="backBtn" style="background:rgba(0,0,0,.5); padding:.5rem .75rem; border-radius:8px;">Quay lại</button>
        </div>
      </div>
    </div>

  </div>
</div>

<footer style="height:8px"></footer>

<script>
/*
  Flappy Bird — optimized
  - Play -> requestFullscreen on #game-container
  - Exit -> location.href back to giaitri.html
  - Sound via WebAudio (simple beeps)
  - Responsive canvas sizing
  - Score + best stored in localStorage
*/

(() => {
  const container = document.getElementById('game-container');
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d', { alpha: false });
  const playBtn = document.getElementById('playBtn');
  const startScreen = document.getElementById('startOverlay');
  const startScreenPlay = document.getElementById('startScreenPlay');
  const exitBtn = document.getElementById('exitBtn');
  const muteBtn = document.getElementById('muteBtn');
  const scoreDisplay = document.getElementById('scoreDisplay');
  const gameOverOverlay = document.getElementById('gameOverOverlay');
  const gameOverText = document.getElementById('gameOverText');
  const retryBtn = document.getElementById('retryBtn');
  const backBtn = document.getElementById('backBtn');

  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  let muted = false;
  let best = parseInt(localStorage.getItem('flappyBest')||0,10);

  function beep(freq=440, duration=0.06, type='sine', gain=0.08) {
    if (muted) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type; o.frequency.value = freq;
    g.gain.value = gain;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); o.disconnect(); g.disconnect(); }, duration*1000);
  }
  function flapSound(){ beep(880,0.04,'triangle',0.06); }
  function pointSound(){ beep(1200,0.06,'square',0.08); }
  function hitSound(){ beep(120,0.18,'sawtooth',0.15); }

  function resizeCanvas() {
    // keep device pixels crisp
    const rect = container.getBoundingClientRect();
    canvas.width = Math.floor(rect.width * devicePixelRatio);
    canvas.height = Math.floor(rect.height * devicePixelRatio);
    canvas.style.width = rect.width + 'px';
    canvas.style.height = rect.height + 'px';
    ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  // Game state
  const STATE = { start:0, play:1, over:2 };
  let state = STATE.start;
  let bird = { x:70, y:100, r:14, vy:0 };
  let pipes = []; // {x,width,top,bottom,passed}
  let score=0, speed=2.4;
  let spawnTimer = 0;

  function reset() {
    bird = { x:70, y: canvas.height/2, r:14, vy:0 };
    pipes = [];
    score = 0;
    speed = Math.max(2.2, canvas.width/360 * 2.4);
    spawnTimer = 0;
    state = STATE.play;
    scoreDisplay.style.display = 'block';
    scoreDisplay.textContent = score;
    gameOverOverlay.style.display = 'none';
  }

  function spawnPipe() {
    const gap = Math.max(110, Math.floor(canvas.height*0.22)); // gap scales
    const min = 40;
    const top = Math.floor(Math.random() * (canvas.height - gap - min*2)) + min;
    const w = Math.max(48, Math.floor(canvas.width*0.12));
    pipes.push({ x: canvas.width + 20, width: w, top: top, bottom: canvas.height - top - gap, passed: false });
  }

  function update(dt) {
    if (state !== STATE.play) return;
    // bird physics
    bird.vy += 0.36; // gravity
    bird.y += bird.vy;

    // spawn pipes periodically
    spawnTimer += dt;
    if (spawnTimer > Math.max(900 - score*20, 600)) {
      spawnPipe(); spawnTimer = 0;
    }

    // move pipes
    for (const p of pipes) p.x -= speed;
    // remove offscreen
    pipes = pipes.filter(p=>p.x + p.width > -10);

    // check collisions & scoring
    for (const p of pipes) {
      if (!p.passed && p.x + p.width < bird.x) {
        p.passed = true; score++; scoreDisplay.textContent = score; pointSound();
        // increase speed gradually each time score increments
        speed += 0.06;
      }
      // collision with vertical pipes
      if (bird.x + bird.r > p.x && bird.x - bird.r < p.x + p.width) {
        if (bird.y - bird.r < p.top || bird.y + bird.r > canvas.height - p.bottom) {
          // hit
          state = STATE.over; hitSound();
          setTimeout(()=> showGameOver(), 200);
        }
      }
    }

    // floor collision
    if (bird.y + bird.r > canvas.height) {
      bird.y = canvas.height - bird.r; state = STATE.over; hitSound(); setTimeout(()=> showGameOver(),200);
    }
    // ceiling
    if (bird.y - bird.r < 0) { bird.y = bird.r; bird.vy = 0; }
  }

  function draw() {
    // sky
    ctx.fillStyle = '#87CEEB'; ctx.fillRect(0,0,canvas.width,canvas.height);
    // ground (simple)
    ctx.fillStyle = '#7c3aed'; ctx.fillRect(0, canvas.height - 40, canvas.width, 40);

    // pipes
    for (const p of pipes) {
      ctx.fillStyle = '#2f855a';
      ctx.fillRect(p.x, 0, p.width, p.top);
      ctx.fillRect(p.x, canvas.height - p.bottom, p.width, p.bottom);
    }

    // bird
    ctx.beginPath();
    ctx.fillStyle = '#f6ad55';
    ctx.arc(bird.x, bird.y, bird.r, 0, Math.PI*2);
    ctx.fill(); ctx.lineWidth = 2; ctx.strokeStyle='#333'; ctx.stroke();

    // score (top center)
    if (state !== STATE.start) {
      ctx.fillStyle='white'; ctx.font='48px Inter, sans-serif'; ctx.textAlign='center';
      ctx.fillText(score, canvas.width/2, 72);
    }
  }

  let lastTime = performance.now();
  function loop(now) {
    const dt = now - lastTime;
    lastTime = now;
    update(dt);
    draw();
    requestAnimationFrame(loop);
  }

  function showGameOver() {
    gameOverOverlay.style.display = 'block';
    gameOverText.textContent = `Điểm: ${score} — Cao nhất: ${best}`;
    if (score > best) { best = score; localStorage.setItem('flappyBest', best); gameOverText.textContent = `MỚI: ${score} điểm!`; }
  }

  function jump() {
    if (state === STATE.start) {
      // start game: hide overlay & request fullscreen
      startScreen.style.display = 'none';
      // resume audio context for some browsers
      audioCtx.resume().catch(()=>{});
      // request fullscreen
      if (container.requestFullscreen) container.requestFullscreen();
      reset();
    }
    if (state === STATE.play) {
      bird.vy = -8;
      flapSound();
    } else if (state === STATE.over) {
      // do nothing or restart
    }
  }

  // Inputs
  container.addEventListener('touchstart', (e)=>{
    e.preventDefault();
    jump();
  }, {passive:false});
  container.addEventListener('mousedown', (e)=>{
    e.preventDefault();
    jump();
  });
  window.addEventListener('keydown', (e)=>{
    if (e.code === 'Space') { e.preventDefault(); jump(); }
    if (e.code === 'Escape' && document.fullscreenElement) document.exitFullscreen();
  });

  // Buttons
  playBtn.addEventListener('click', ()=> startScreenPlay.click());
  startScreenPlay.addEventListener('click', ()=> {
    jump();
  });
  exitBtn.addEventListener('click', ()=> {
    location.href = '../giaitri.html';
  });
  retryBtn.addEventListener('click', ()=> {
    reset();
  });
  backBtn.addEventListener('click', ()=> {
    location.href = '../giaitri.html';
  });
  muteBtn.addEventListener('click', ()=> {
    muted = !muted; muteBtn.textContent = muted? '🔇':'🔈';
  });

  // initialize and start loop
  resizeCanvas();
  lastTime = performance.now();
  requestAnimationFrame(loop);

})();
</script>
</body>
</html>
