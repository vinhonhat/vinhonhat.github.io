<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test PC | Vinh ở Nhật</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#F6AD55">
    <link rel="apple-touch-icon" href="/img/logo1.png">
    <link rel="icon" href="/img/logoQV.png" type="image/x-icon">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="/css/style.css">

    <style>
        /* [CSS] CHUNG */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: 'Inter', sans-serif; /* Font chữ chung */
        }

        /* ======================
           [CSS] MÀN HÌNH (ĐÃ CHỈNH SỬA)
           ====================== */
        /* Đây là CSS cho vùng #screen-tester ở chế độ xem trước (chưa fullscreen) */
        /* Đã chỉnh sửa để giống một "section" (như file copy) */
        #screen-tester {
            max-width: 900px; /* Giống các section khác */
            width: 100%;
            height: 200px; /* Chiều cao cố định (như file copy) */
            margin: 20px auto; /* Căn giữa (như file copy) */
            display: flex; /* Dùng flexbox để căn giữa nội dung (tên màu) */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer; /* Biểu tượng bàn tay */
            transition: background-color 0.3s ease; /* Hiệu ứng đổi màu */
            background-color: #333; /* Màu nền ban đầu */
            position: relative;
            border-radius: 10px; /* Bo góc */
            box-shadow: 0 3px 8px rgba(0,0,0,0.1); /* Thêm bóng (như file copy) */
        }

        /* [LOGIC CSS QUAN TRỌNG] - GIỮ NGUYÊN TỪ BẢN CHÍNH */
        /* CSS này CHỈ áp dụng khi trình duyệt ở chế độ FULLSCREEN */
        /* :fullscreen #screen-tester = "Tìm #screen-tester bên trong một element đang fullscreen" */
        :fullscreen #screen-tester {
             width: 100% !important; /* Buộc rộng 100% */
             height: 100vh !important; /* Buộc cao 100% */
             position: fixed !important; /* Cố định vị trí */
             top: 0 !important;
             left: 0 !important;
             z-index: 9999 !important; /* QUAN TRỌNG: Đè lên mọi thứ khác */
             border-radius: 0 !important; /* Bỏ bo góc khi fullscreen */
        }

        /* Tên màu (ĐEN, TRẮNG...) */
        #color-name {
            color: white; /* Chữ trắng */
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5); /* Đổ bóng cho dễ đọc */
            font-size: 1.5em;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Class này được JS thêm/xóa để ẨN chữ khi test nền Đen/Trắng */
        .hide-text #color-name {
            display: none;
        }
        
        /* [CSS] TIỆN ÍCH (Cắt chữ 2 dòng) */
        .truncate-2-lines {
             display: -webkit-box;
             -webkit-box-orient: vertical;
             -webkit-line-clamp: 2; 
             overflow: hidden;
        }

        /* ======================
           [CSS] BÀN PHÍM (GIỮ NGUYÊN TỪ BẢN CHÍNH)
           ====================== */
        #keyboard-layout-container {
            overflow-x: hidden; /* Ẩn thanh cuộn ngang (nếu layout quá rộng) */
        }

        /* Một HÀNG phím */
        .key-row {
            display: flex; /* Dùng flexbox để xếp các phím trên 1 hàng */
            margin-bottom: 5px; /* khoảng cách giữa các hàng */
            gap: 5px; /* khoảng cách (gap) giữa các phím */
        }

        /* Một PHÍM ảo */
        .key {
            background-color: #333; /* Nền xám tối */
            color: white; /* Chữ trắng */
            border: 1px solid #555;
            padding: 2px 5px;
            border-radius: 4px;
            text-align: center;
            font-size: 12px;
            min-width: 0; /* Cho phép phím co lại */
            flex-grow: 1; /* [LOGIC CSS QUAN TRỌNG]: Cho phép phím tự co giãn lấp đầy hàng */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 35px;
            transition: background-color 0.1s, border-color 0.1s;
            cursor: default;
            flex-direction: column;
            line-height: 1.1;
        }

        /* Trạng thái phím khi ĐANG ĐƯỢC NHẤN (active) */
        .key.active {
            background-color: #F6AD55 !important; /* Nền cam */
            border-color: #FFD700 !important;
            color: #111 !important; /* Chữ đen */
            box-shadow: 0 0 10px rgba(246, 173, 85, 0.8); /* Hiệu ứng sáng */
        }

        /* Trạng thái phím khi ĐÃ ĐƯỢC TEST (checked) */
        .key.checked {
            background-color: #9b9a9a !important; /* Nền xám (đã test) */
            border-color: #cc4e4e !important; /* Viền đỏ (đã test) */
            color: rgb(38, 0, 255) !important; /* Chữ xanh (đã test) */
        }

        /* Tỉ lệ phím (dùng flex-grow để co giãn, thay vì width cố định) */
        .key.key-tab { flex-grow: 1.5; }
        .key.key-caps { flex-grow: 1.75; }
        .key.key-shift-l { flex-grow: 2.25; }
        .key.key-shift-r { flex-grow: 2.75; }
        .key.key-enter { flex-grow: 2.25; }
        .key.key-backslash { flex-grow: 1.5; }
        .key.key-space { flex-grow: 5; max-width: none; } /* Phím Space rộng nhất */

        /* Phím modifier (Ctrl, Alt...) có độ rộng tối thiểu */
        .key.key-modifier { min-width: 50px; }
	</style>
</head>
<body class="bg-[#FBF7F0]">
    
<div id="header-placeholder"></div>

<main>
    <h2 class="text-3xl font-bold text-gray-800 text-center mb-10"></h2>
    <h3 class="text-3xl font-bold text-gray-800 text-center mb-10">Công cụ Kiểm tra Màn hình, Loa, Mic & Camera</h2>
    <div id="screen-tester">
        <h1 id="color-name">Nhấn vào đây hoặc phím Space để bắt đầu kiểm tra (Full Screen)</h1>
        <p id="sub-text" class="text-white text-sm opacity-70">Nhấn ESC hoặc Q để thoát</p>
    </div>
    
    <div class="max-w-4xl mx-auto py-12 px-4">
        

        <div id="speaker-tester" class="bg-white p-6 rounded-lg shadow-lg mb-8">
            <h3 class="text-2xl font-semibold mb-4 flex items-center"><i class="fas fa-volume-up mr-3 text-blue-500"></i>Kiểm Tra Loa (Stereo Check)</h3>
            <p class="text-center text-lg mb-4" id="speaker-status">Chọn một nút để kiểm tra loa trái, phải, hoặc cả hai (stereo).</p>
            <div class="flex justify-center items-center flex-wrap gap-4">
                <button id="left-speaker" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded transition duration-300">
                    <i class="fas fa-volume-up mr-2"></i>LOA TRÁI
                </button>
                <button id="stereo-speaker" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded transition duration-300">
                    <i class="fas fa-volume-up mr-2"></i>GIỮA (STEREO)
                </button>
                 <button id="right-speaker" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded transition duration-300">
                    <i class="fas fa-volume-up mr-2"></i>LOA PHẢI
                </button>
                <button id="stop-speaker" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded transition duration-300">
                    <i class="fas fa-stop mr-2"></i>DỪNG
                </button>
            </div>
            <audio id="audio-player"></audio>
        </div>
        
        <div id="camera-mic-tester" class="bg-white p-6 rounded-lg shadow-lg">
            <h3 class="text-2xl font-semibold mb-4 flex items-center"><i class="fas fa-video mr-3 text-red-500"></i>Kiểm Tra Mic & Camera</h3>
            <p class="text-center text-lg mb-4" id="camera-mic-status">Vui lòng cho phép dùng camera và mic để kiểm tra. Camera sẽ hiển thị, Mic sẽ hiển thị mức độ âm thanh.</p>
            <div class="flex justify-center mb-6">
                <button id="start-camera-mic-check" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded transition duration-300">
                    <i class="fas fa-camera mr-2"></i>KIỂM TRA
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <p class="font-medium text-center mb-2">Camera Preview</p>
                    <video id="video-preview" autoplay muted class="w-full bg-gray-200 rounded h-48"></video>
                </div>
                <div>
                    <p class="font-medium text-center mb-2">Microphone Level</p>
                    <canvas id="mic-level-canvas" class="w-full bg-gray-200 rounded h-48"></canvas>
                </div>
            </div>
        </div>

        <div id="keyboard-tester" class="mt-12">
            <h3 class="text-2xl font-semibold mb-6 flex items-center"><i class="fas fa-keyboard mr-3 text-yellow-600"></i>Kiểm Tra Bàn Phím (Keyboard Test)</h3>
            <p class="text-center text-lg mb-4" id="keyboard-status">Nhấn bất kỳ phím nào trên bàn phím của bạn để kiểm tra phản hồi.</p>

            <div id="keyboard-layout-container" class="bg-gray-900 p-6 rounded-lg shadow-xl overflow-x-auto">
                </div>

        </div>

        <div id="trackpad-area" class="mt-4 p-4 flex justify-center items-center gap-2" style="user-select: none;">
            <div id="mouse-left-display" class="w-28 h-16 border-2 border-gray-500 rounded text-gray-400 flex justify-center items-center transition-all duration-100">
                Trái
            </div>
            <div id="mouse-middle-display" class="w-20 h-16 border-2 border-gray-500 rounded text-gray-400 flex justify-center items-center transition-all duration-100">
                Giữa
            </div>
            <div id="mouse-right-display" class="w-28 h-16 border-2 border-gray-500 rounded text-gray-400 flex justify-center items-center transition-all duration-100">
                Phải
            </div>
        </div>

        <p class="text-center text-sm text-gray-500">Click bất cứ đâu trong khu vực bàn phím để kiểm tra</p>

        <div class="mt-4 text-center text-sm text-gray-500">
            <i class="fas fa-desktop mr-1"></i> Hệ điều hành: <span id="os-display" class="font-bold">Đang nhận diện...</span>
        </div>
    </div>
</main>

<div id="footer-placeholder"></div>

<script>
    // =========================================================================
    // [JS] MÀN HÌNH (GIỮ NGUYÊN TỪ BẢN CHÍNH, CHỈ XÓA LOGIC LIÊN QUAN TỚI NÚT CHUYỂN)
    // =========================================================================

    // Mảng (const) chứa danh sách các màu để test
    const colors = [
        { name: "ĐEN", hex: "#000000" },
        { name: "TRẮNG", hex: "#FFFFFF" },
        { name: "ĐỎ", hex: "#FF0000" },
        { name: "XANH LÁ", hex: "#00FF00" },
        { name: "XANH DƯƠNG", hex: "#0000FF" }, // Chỗ này file gốc bạn ghi #00FF00 (Xanh lá)
        { name: "VÀNG", hex: "#FFFF00" },
        { name: "TÍM", hex: "#FF00FF" },
        { name: "XÁM", hex: "#808080" }
    ];

    // Biến trạng thái
    let currentIndex = -1; // Biến đếm (index) màu, -1 để lần đầu nhấn là 0 (ĐEN)
    const screenTester = document.getElementById('screen-tester');         // Vùng hiển thị
    const colorNameDisplay = document.getElementById('color-name');       // Thẻ <h1> tên màu
    const subText = document.getElementById('sub-text');                  // Thẻ <p> hướng dẫn thoát
    let isFirstInteraction = true;                                        // Cờ (flag) để biết đây là lần nhấn đầu (để bật fullscreen)

    /**
     * [LOGIC ĐỂ PORT]: Hàm Bật/Tắt Fullscreen (Đã xóa code của modeSwitcher)
     */
    function toggleFullscreen() {
        const body = document.body;
        // Kiểm tra xem trình duyệt CÓ đang ở fullscreen KHÔNG
        if (!document.fullscreenElement) {
            // Nếu KHÔNG, thì BẬT fullscreen
            if (screenTester.requestFullscreen) {
                screenTester.requestFullscreen();
            } else if (screenTester.webkitRequestFullscreen) { // Safari
                screenTester.webkitRequestFullscreen();
            } else if (screenTester.msRequestFullscreen) { // IE11
                screenTester.msRequestFullscreen();
            }
            subText.style.display = 'block'; // Hiện hướng dẫn thoát
            // (ĐÃ XÓA: modeSwitcher.style.display = 'none';)
        } else {
            // Nếu ĐANG ở fullscreen, thì TẮT
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }
            subText.style.display = 'none'; // Ẩn hướng dẫn
            // (ĐÃ XÓA: modeSwitcher.style.display = 'block';)
        }
    }

    // Ban đầu, ẩn hướng dẫn thoát (vì chưa vào fullscreen)
    subText.style.display = 'none';

    // Bắt sự kiện 'fullscreenchange' (khi người dùng tự nhấn ESC để thoát)
    document.addEventListener('fullscreenchange', (event) => {
        // Nếu không còn element nào ở chế độ fullscreen (nghĩa là vừa thoát)
        if (!document.fullscreenElement) {
            // Reset giao diện về trạng thái xem trước
            screenTester.style.backgroundColor = '#333';
            colorNameDisplay.textContent = 'Bấm hoặc nhấn Space để bắt đầu kiểm tra (Full Screen)';
            screenTester.classList.remove('hide-text'); // Bỏ class ẩn text
            isFirstInteraction = true; // Reset cờ, để lần sau nhấn lại vào fullscreen
            subText.style.display = 'none'; // Ẩn hướng dẫn
            // (ĐÃ XÓA: modeSwitcher.style.display = 'block';)
        }
    });

    /**
     * [LOGIC ĐỂ PORT]: Hàm chính xử lý đổi màu (Đã xóa code của modeSwitcher)
     */
    function changeColor() {
        // Nếu là lần nhấn đầu tiên, gọi hàm bật fullscreen
        if (isFirstInteraction) {
            toggleFullscreen();
            isFirstInteraction = false;
        }

        // (ĐÃ XÓA: Logic kiểm tra screenTester.style.display === 'none')

        // Tăng index, dùng phép % (chia lấy dư) để lặp vòng mảng
        currentIndex = (currentIndex + 1) % colors.length;
        const currentColor = colors[currentIndex]; // Lấy màu hiện tại

        // Cập nhật màu nền và tên màu
        screenTester.style.backgroundColor = currentColor.hex;
        colorNameDisplay.textContent = currentColor.name;

        // Xử lý đặc biệt: Nếu nền TRẮNG, đổi chữ thành ĐEN
        if (currentColor.hex === "#FFFFFF") {
            colorNameDisplay.style.color = "black";
        } else {
            colorNameDisplay.style.color = "white";
        }

        // Ẩn chữ và hướng dẫn khi test nền ĐEN, TRẮNG, XÁM (để dễ soi điểm chết)
        if (currentColor.hex === "#000000" || currentColor.hex === "#FFFFFF" || currentColor.hex === "#808080") {
            screenTester.classList.add('hide-text'); // Thêm class CSS đã định nghĩa
            subText.style.display = 'none';
        } else {
            screenTester.classList.remove('hide-text'); // Bỏ class
            subText.style.display = 'block';
        }
    }

    // Gán sự kiện 'click' vào vùng test màn hình -> gọi hàm đổi màu
    screenTester.addEventListener('click', changeColor);

    // Gán sự kiện 'keydown' (nhấn phím) cho toàn bộ trang
    document.addEventListener('keydown', (e) => {
        // Nếu nhấn Space hoặc Enter
        if (e.code === 'Space' || e.code === 'Enter') {
            e.preventDefault(); // Ngăn hành vi mặc định (như cuộn trang)
            
            // Chỉ đổi màu nếu đang ở chế độ test màn hình (hoặc sắp vào)
            // (Logic cũ 'screenTester.style.display !== 'none'' vẫn đúng)
            if (screenTester.style.display !== 'none') {
                // Kiểm tra xem focus có đang ở trong 1 input/button khác không
                // Nếu là body hoặc screenTester thì mới chạy
                if(document.activeElement === document.body || document.activeElement === screenTester) {
                     changeColor();
                }
            }
        }
        // Nếu nhấn phím 'Q' VÀ đang ở fullscreen -> thoát
        if (e.code === 'KeyQ' && document.fullscreenElement) {
            toggleFullscreen();
        }
    });

    // =========================================================================
    // [JS] LOA (ĐÃ THAY ĐỔI THEO YÊU CẦU 4 NÚT)
    // =========================================================================

    // Lấy các phần tử DOM
    const audioPlayer = document.getElementById('audio-player');           // Thẻ <audio>
    const speakerStatus = document.getElementById('speaker-status');       // Thẻ <p> trạng thái loa

    // Gán sự kiện cho các nút loa
    document.getElementById('left-speaker').addEventListener('click', () => {
        // Đường dẫn từ file 1
        audioPlayer.src = '/file/mp3/left_speaker.mp3'; 
        audioPlayer.play().catch(e => { 
            speakerStatus.textContent = 'Lỗi phát âm thanh. Vui lòng click lại.'; 
            console.error(e); 
        });
        speakerStatus.textContent = 'Đang phát: LOA TRÁI';
    });

    document.getElementById('right-speaker').addEventListener('click', () => {
        // Đường dẫn từ file 1 (ĐÃ SỬA LỖI TYPO 'right_speakermp3')
        audioPlayer.src = '/file/mp3/right_speaker.mp3'; 
        audioPlayer.play().catch(e => { 
            speakerStatus.textContent = 'Lỗi phát âm thanh. Vui lòng click lại.'; 
            console.error(e); 
        });
        speakerStatus.textContent = 'Đang phát: LOA PHẢI';
    });

    document.getElementById('stereo-speaker').addEventListener('click', () => {
        // Giả định đường dẫn từ file 2 ('stereo.mp3')
        audioPlayer.src = '/file/mp3/stereo.mp3'; 
        audioPlayer.play().catch(e => { 
            speakerStatus.textContent = 'Lỗi phát âm thanh. Vui lòng click lại.'; 
            console.error(e); 
        });
        speakerStatus.textContent = 'Đang phát: STEREO (Cả hai loa)';
    });

    document.getElementById('stop-speaker').addEventListener('click', () => {
        audioPlayer.pause();
        audioPlayer.currentTime = 0;
        speakerStatus.textContent = 'Đã dừng. Chọn loa để kiểm tra.';
    });

    // =========================================================================
    // [JS] CAMERA & MIC (GIỮ NGUYÊN TỪ BẢN CHÍNH)
    // =========================================================================

    // Lấy các phần tử DOM
    const startCameraMicButton = document.getElementById('start-camera-mic-check'); // Nút "KIỂM TRA"
    const videoPreview = document.getElementById('video-preview'); // Thẻ <video>
    const micLevelCanvas = document.getElementById('mic-level-canvas'); // Thẻ <canvas>
    const canvasCtx = micLevelCanvas.getContext('2d'); // Lấy "bút vẽ" 2D cho canvas
    const cameraMicStatus = document.getElementById('camera-mic-status'); // Thẻ <p> trạng thái
    let animationFrame; // Biến lưu ID của requestAnimationFrame (để dừng khi cần)

    /**
     * [LOGIC ĐỂ PORT]: Logic chính Camera & Mic
     */
    startCameraMicButton.addEventListener('click', () => {
        startCameraMicButton.disabled = true; // Khóa nút
        cameraMicStatus.textContent = 'Đang yêu cầu cấp quyền...'; // Cập nhật trạng thái

        // Sử dụng API chuẩn của trình duyệt: navigator.mediaDevices.getUserMedia
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => { // Nếu người dùng ĐỒNG Ý
                cameraMicStatus.textContent = 'Đã cấp quyền. Camera và Mic đang hoạt động.';

                // 1) Xử lý Camera:
                videoPreview.srcObject = stream;

                // 2) Xử lý Microphone:
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const analyser = audioContext.createAnalyser();
                const microphone = audioContext.createMediaStreamSource(stream);

                microphone.connect(analyser);
                analyser.fftSize = 256; 
                const bufferLength = analyser.frequencyBinCount; 
                const dataArray = new Uint8Array(bufferLength); 

                function draw() {
                    canvasCtx.clearRect(0, 0, micLevelCanvas.width, micLevelCanvas.height);
                    analyser.getByteFrequencyData(dataArray);

                    let sum = 0;
                    for (let i = 0; i < bufferLength; i++) {
                        sum += dataArray[i];
                    }
                    const average = sum / bufferLength;

                    const barHeight = average * 1.5;
                    const finalHeight = Math.min(barHeight, micLevelCanvas.height);

                    canvasCtx.fillStyle = '#C0392B'; // Màu đỏ
                    canvasCtx.fillRect(0, micLevelCanvas.height - finalHeight, micLevelCanvas.width, finalHeight);

                    animationFrame = requestAnimationFrame(draw);
                }
                draw(); // Bắt đầu vòng lặp vẽ
            })
            .catch(err => { // Nếu người dùng TỪ CHỐI hoặc có lỗi
                cameraMicStatus.textContent = `LỖI TRUY CẬP: ${err.name}. Vui lòng kiểm tra quyền truy cập Camera/Mic.`;
                startCameraMicButton.disabled = false; // Mở khóa nút để thử lại
            });
    });

    // =========================================================================
    // [JS] BÀN PHÍM (GIỮ NGUYÊN TỪ BẢN CHÍNH)
    // =========================================================================

    // Lấy các phần tử DOM
    const keyboardLayoutContainer = document.getElementById('keyboard-layout-container');
    const osDisplay = document.getElementById('os-display');

    /**
     * [LOGIC ĐỂ PORT]: Định nghĩa Layout Bàn Phím
     */
    const KEY_LAYOUTS = {
        windows: [
            ['Escape', 'F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8', 'F9', 'F10', 'F11', 'F12', 'PrintScreen', 'ScrollLock', 'Pause', 'Home', 'End'],
            ['Backquote', 'Digit1', 'Digit2', 'Digit3', 'Digit4', 'Digit5', 'Digit6', 'Digit7', 'Digit8', 'Digit9', 'Digit0', 'Minus', 'Equal', 'Backspace', 'NumLock', 'NumpadDivide', 'NumpadMultiply', 'NumpadSubtract', 'NumpadAdd'],
            ['Tab', 'KeyQ', 'KeyW', 'KeyE', 'KeyR', 'KeyT', 'KeyY', 'KeyU', 'KeyI', 'KeyO', 'KeyP', 'BracketLeft', 'BracketRight', 'Backslash', '','Numpad7', 'Numpad8', 'Numpad9'],
            ['CapsLock', 'KeyA', 'KeyS', 'KeyD', 'KeyF', 'KeyG', 'KeyH', 'KeyJ', 'KeyK', 'KeyL', 'Semicolon', 'Quote', 'Enter', '','Numpad4', 'Numpad5', 'Numpad6'],
            ['ShiftLeft', 'KeyZ', 'KeyX', 'KeyC', 'KeyV', 'KeyB', 'KeyN', 'KeyM', 'Comma', 'Period', 'Slash', 'ShiftRight', '','Numpad1', 'Numpad2', 'Numpad3'],
            ['ControlLeft', 'MetaLeft', 'AltLeft', 'Space', 'AltRight', 'ContextMenu', 'ControlRight', 'ArrowUp', '','Numpad0', 'NumpadDecimal', 'NumpadEnter'],
            ['', '', '', '', '', '', '','', '','', '','', '', '', 'ArrowLeft', 'ArrowDown', 'ArrowRight','','', '','','']
        ],
        macos: [
            ['Escape', 'F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8', 'F9', 'F10', 'F11', 'F12', 'VolumeUp', 'VolumeDown', 'Mute', 'PlayPause', 'Eject'],
            ['Backquote', 'Digit1', 'Digit2', 'Digit3', 'Digit4', 'Digit5', 'Digit6', 'Digit7', 'Digit8', 'Digit9', 'Digit0', 'Minus', 'Equal', 'Backspace'],
            ['Tab', 'KeyQ', 'KeyW', 'KeyE', 'KeyR', 'KeyT', 'KeyY', 'KeyU', 'KeyI', 'KeyO', 'KeyP', 'BracketLeft', 'BracketRight', 'Backslash'],
            ['CapsLock', 'KeyA', 'KeyS', 'KeyD', 'KeyF', 'KeyG', 'KeyH', 'KeyJ', 'KeyK', 'KeyL', 'Semicolon', 'Quote', 'Enter'],
            ['ShiftLeft', 'KeyZ', 'KeyX', 'KeyC', 'KeyV', 'KeyB', 'KeyN', 'KeyM', 'Comma', 'Period', 'Slash', 'ShiftRight'],
            ['ControlLeft', 'AltLeft', 'MetaLeft', 'Space', 'MetaRight', 'AltRight', 'ControlRight', 'ArrowUp', '', ''],
            ['', '', '', '', '', '', '', '', '', '', '', '', '', '','','','','', 'ArrowLeft', 'ArrowDown', 'ArrowRight']
        ]
    };

    /**
     * [LOGIC ĐỂ PORT]: Ánh xạ (Map) 'e.code' sang Nhãn (text)
     */
    const KEY_LABELS = {
        'Escape': 'Esc', 'Tab': 'Tab', 'CapsLock': 'Caps', 'ShiftLeft': 'Shift', 'ShiftRight': 'Shift',
        'ControlLeft': 'Ctrl', 'ControlRight': 'Ctrl', 'AltLeft': 'Alt', 'AltRight': 'Alt',
        'MetaLeft': '⌘/Win', 'MetaRight': '⌘/Win', 'Space': 'Space', 'Enter': 'Enter',
        'Backspace': 'Delete', 'Backquote': '` ~', 'Minus': '- _', 'Equal': '= +',
        'BracketLeft': '[ {', 'BracketRight': '] }', 'Backslash': '\\ |', 'Semicolon': '; :',
        'Quote': `' "`, 'Comma': ', <', 'Period': '. >', 'Slash': '/ ?',
        'Digit1': '1', 'Digit2': '2', 'Digit3': '3', 'Digit4': '4', 'Digit5': '5',
        'Digit6': '6 ', 'Digit7': '7 ', 'Digit8': '8 ', 'Digit9': '9', 'Digit0': '0',
        'PrintScreen': 'PrtSc', 'ScrollLock': 'ScrLk', 'Pause': 'Pause', 'Insert': 'Ins', 'Delete': 'Del',
        'ArrowUp': '↑', 'ArrowDown': '↓', 'ArrowLeft': '←', 'ArrowRight': '→',
        'ContextMenu': 'Menu', 'NumpadDivide': '/', 'NumpadMultiply': '*', 'NumpadSubtract': '-',
        'NumpadAdd': '+', 'NumpadDecimal': '.', 'NumpadEnter': 'Enter',
        'Numpad0': '0', 'Numpad1': '1', 'Numpad2': '2', 'Numpad3': '3', 'Numpad4': '4',
        'Numpad5': '5', 'Numpad6': '6', 'Numpad7': '7', 'Numpad8': '8', 'Numpad9': '9',
        // Tự động thêm A-Z
        'KeyA': 'A', 'KeyB': 'B', 'KeyC': 'C', 'KeyD': 'D', 'KeyE': 'E', 'KeyF': 'F',
        'KeyG': 'G', 'KeyH': 'H', 'KeyI': 'I', 'KeyJ': 'J', 'KeyK': 'K', 'KeyL': 'L',
        'KeyM': 'M', 'KeyN': 'N', 'KeyO': 'O', 'KeyP': 'P', 'KeyQ': 'Q', 'KeyR': 'R',
        'KeyS': 'S', 'KeyT': 'T', 'KeyU': 'U', 'KeyV': 'V', 'KeyW': 'W', 'KeyX': 'X',
        'KeyY': 'Y', 'KeyZ': 'Z',
    };
    // Thêm tự động nhãn F1..F12
    for (let i = 1; i <= 12; i++) { KEY_LABELS[`F${i}`] = `F${i}`; }

    /**
     * Hàm: detectOS()
     */
    function detectOS() {
        const userAgent = window.navigator.userAgent.toLowerCase();
        if (userAgent.indexOf('mac') > -1) {
            return 'macos';
        }
        if (userAgent.indexOf('win') > -1) {
            return 'windows';
        }
        return 'windows'; // Mặc định là Windows
    }
    const currentOS = detectOS(); // Chạy hàm
    osDisplay.textContent = currentOS === 'macos' ? 'macOS' : 'Windows OS'; // Hiển thị HĐH

    /**
     * [LOGIC ĐỂ PORT]: Hàm Xây Dựng (Tạo) Layout Bàn Phím
     */
    function buildKeyboardLayout(os) {
        const layout = KEY_LAYOUTS[os]; // Lấy layout (Windows hoặc Mac)
        keyboardLayoutContainer.innerHTML = ''; // Xóa sạch layout cũ (nếu có)

        // Lặp qua từng HÀNG (row)
        layout.forEach(row => {
            const rowDiv = document.createElement('div'); // Tạo <div> cho hàng
            rowDiv.className = 'key-row'; // Gán class CSS (đã định nghĩa ở <style>)

            // Lặp qua từng PHÍM (keyCode) trong hàng
            row.forEach(keyCode => {
                if (!keyCode) { // Nếu keyCode là '' (chuỗi rỗng) -> tạo spacer
                    const spacer = document.createElement('div');
                    spacer.style.width = '30px';
                    rowDiv.appendChild(spacer);
                    return; // Bỏ qua, sang phím tiếp
                }

                // Tạo <div> cho phím
                const keyDiv = document.createElement('div');
                keyDiv.className = 'key';
                keyDiv.id = `key-${keyCode}`; 
                keyDiv.textContent = KEY_LABELS[keyCode] || keyCode.replace('Key', '');

                // Thêm các class CSS đặc biệt cho các phím dài (để flex-grow)
                if (keyCode === 'Tab') keyDiv.classList.add('key-tab');
                if (keyCode === 'CapsLock') keyDiv.classList.add('key-caps');
                if (keyCode === 'ShiftLeft') keyDiv.classList.add('key-shift-l');
                if (keyCode === 'ShiftRight') keyDiv.classList.add('key-shift-r');
                if (keyCode === 'Enter') keyDiv.classList.add('key-enter');
                if (keyCode === 'Space') keyDiv.classList.add('key-space');
                if (['ControlLeft', 'ControlRight', 'AltLeft', 'AltRight', 'MetaLeft', 'MetaRight'].includes(keyCode)) {
                    keyDiv.classList.add('key-modifier');
                }

                rowDiv.appendChild(keyDiv); // Gắn phím vào hàng
            });

            keyboardLayoutContainer.appendChild(rowDiv); // Gắn hàng vào container
        });
    }

    // Chạy hàm build bàn phím ngay khi script tải
    buildKeyboardLayout(currentOS);

    // --- Xử lý sự kiện bàn phím (keydown và keyup) ---
    
    /**
     * [LOGIC ĐỂ PORT]: Bắt sự kiện phím ĐANG NHẤN (keydown)
     * (Đã xóa logic kiểm tra 'peripheralTester.style.display')
     */
    document.addEventListener('keydown', (e) => {
        // CHỈ xử lý khi KHÔNG ở fullscreen (tránh xung đột với phím Space đổi màu)
        if (!document.fullscreenElement) {
            const targetKey = document.getElementById(`key-${e.code}`);
            if (targetKey) { // Nếu tìm thấy phím
                e.preventDefault(); // Ngăn hành vi mặc định (vd: gõ chữ)
                targetKey.classList.add('active');
                targetKey.classList.remove('checked'); // Xóa class 'checked' (nếu có)
            }
        }
    });

    /**
     * [LOGIC ĐỂ PORT]: Bắt sự kiện phím được THẢ RA (keyup)
     * (Đã xóa logic kiểm tra 'peripheralTester.style.display')
     */
    document.addEventListener('keyup', (e) => {
        // CHỈ xử lý khi KHÔNG ở fullscreen
        if (!document.fullscreenElement) {
            const targetKey = document.getElementById(`key-${e.code}`);
            if (targetKey) {
                targetKey.classList.remove('active'); // Bỏ class 'active' (hết cam)
                targetKey.classList.add('checked'); // Thêm class 'checked' (màu xám, đã test)
            }
        }
    });

    /**
     * [LOGIC ĐỂ PORT]: Hàm Reset bàn phím (xóa trạng thái)
     */
    function resetKeyboard() {
        // Tìm tất cả các phím đã 'checked' hoặc 'active'
        const checkedKeys = keyboardLayoutContainer.querySelectorAll('.key.checked, .key.active');
        // Xóa class của chúng
        checkedKeys.forEach(key => {
            key.classList.remove('checked');
            key.classList.remove('active');
        });
        const statusEl = document.getElementById('keyboard-status');
        if (statusEl) {
            statusEl.textContent = 'Nhấn bất kỳ phím nào trên bàn phím của bạn để kiểm tra phản hồi.';
        }
    }
    
    // =========================================================================
    // [JS] CHUỘT / TRACKPAD (GIỮ NGUYÊN TỪ BẢN CHÍNH)
    // =========================================================================
    (function() {
        const captureZone = document.getElementById('keyboard-tester'); 
        const leftDisplay = document.getElementById('mouse-left-display');
        const rightDisplay = document.getElementById('mouse-right-display');
        const middleDisplay = document.getElementById('mouse-middle-display');

        if (!captureZone || !leftDisplay || !rightDisplay || !middleDisplay) {
            console.error('Không tìm thấy các thành phần của trackpad.');
            return;
        }

        const activeBorder = '#F6AD55'; 
        const activeBg = 'rgba(246, 173, 85, 0.2)';
        const activeText = '#F6AD55';
        const defaultBorder = '#6B7280'; // gray-500
        const defaultText = '#9CA3AF'; // gray-400

        /**
         * [LOGIC ĐỂ PORT]: Hàm xử lý khi NHẤN chuột (mousedown)
         */
        function handleMouseDown(e) {
            e.preventDefault(); // Ngăn chọn (select) text
            switch (e.button) {
                case 0: // 0 = Chuột TRÁI
                    leftDisplay.style.borderColor = activeBorder;
                    leftDisplay.style.backgroundColor = activeBg;
                    leftDisplay.style.color = activeText;
                    break;
                case 1: // 1 = Chuột GIỮA (con lăn)
                    middleDisplay.style.borderColor = activeBorder;
                    middleDisplay.style.backgroundColor = activeBg;
                    middleDisplay.style.color = activeText;
                    break;
                case 2: // 2 = Chuột PHẢI
                    rightDisplay.style.borderColor = activeBorder;
                    rightDisplay.style.backgroundColor = activeBg;
                    rightDisplay.style.color = activeText;
                    break;
            }
        }

        /**
         * [LOGIC ĐỂ PORT]: Hàm xử lý khi THẢ chuột (mouseup)
         */
        function handleMouseUp(e) {
            e.preventDefault();
            switch (e.button) {
                case 0: // Trái
                    leftDisplay.style.borderColor = defaultBorder;
                    leftDisplay.style.backgroundColor = 'transparent';
                    leftDisplay.style.color = defaultText;
                    break;
                case 1: // Giữa
                    middleDisplay.style.borderColor = defaultBorder;
                    middleDisplay.style.backgroundColor = 'transparent';
                    middleDisplay.style.color = defaultText;
                    break;
                case 2: // Phải
                    rightDisplay.style.borderColor = defaultBorder;
                    rightDisplay.style.backgroundColor = 'transparent';
                    rightDisplay.style.color = defaultText;
                    break;
            }
        }

        // Gán sự kiện cho vùng captureZone
        captureZone.addEventListener('mousedown', handleMouseDown);
        captureZone.addEventListener('mouseup', handleMouseUp);

        // Ngăn menu chuột phải hiện lên trong vùng test
        captureZone.addEventListener('contextmenu', (e) => e.preventDefault());

        // Ngăn chọn text
        captureZone.style.userSelect = 'none';
    })();

</script>

<script src="/js/script.js"></script>
<script src="/js/content.js"></script>
<script src="/pages/page-logic.js"></script>
</body>
</html>