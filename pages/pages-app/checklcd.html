<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ kiểm tra Màn hình, Loa, Mic & Camera | Vinh ở Nhật</title>
 
<link rel="manifest" href="manifest.json"> 

<meta name="theme-color" content="#F6AD55"> 

<link rel="apple-touch-icon" href="/img/logo1.png"> 
    
<link rel="icon" href="/img/logoQV.png" type="image/x-icon"> 

<script src="https://cdn.tailwindcss.com"></script>
    
<link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<link rel="stylesheet" href="/css/style.css">

	<style>
        /* CSS cho công cụ kiểm tra */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: 'Inter', sans-serif;
        }

        /* 1. KHU VỰC KIỂM TRA MÀN HÌNH (Mặc định thu nhỏ) */
        #screen-tester {
            width: 100%;
            height: 50vh; /* Thu nhỏ ban đầu */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer; 
            transition: background-color 0.3s ease; 
            background-color: #333; 
            position: relative;
            margin-top: 0; 
        }
        
        /* Chế độ Full Screen sẽ làm cho màn hình chiếm toàn bộ viewport */
        :fullscreen #screen-tester {
             height: 100vh !important;
             position: fixed !important;
             top: 0 !important;
             left: 0 !important;
             z-index: 9999 !important;
        }

        #color-name {
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            font-size: 2em;
            margin-bottom: 20px;
            text-align: center;
        }

        .hide-text #color-name {
            display: none;
        }
        
        /* CSS cho nút chuyển chế độ (KHÔNG DÙNG FIXED NỮA) */
        #mode-switcher {
            /* Loại bỏ position: fixed; */
            margin: 20px auto; /* Căn giữa và tạo khoảng cách */
            display: block; /* Đảm bảo nó là block để căn giữa */
            max-width: 300px;
            z-index: 1000;
            padding: 10px 15px;
            background: #F6AD55; /* Màu theme của bạn */
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        #mode-switcher:hover {
            background: #d68e3e;
        }

        /* CSS còn lại của bạn */
        .truncate-2-lines {
             display: -webkit-box;
             -webkit-box-orient: vertical;
             -webkit-line-clamp: 2; 
             overflow: hidden;
        }



        /* CSS MỚI Tối ưu cho bàn phím */
        #keyboard-layout-container {
            /* Loại bỏ overflow-x-auto */
            overflow-x: hidden; 
        }

        .key-row {
            display: flex;
            margin-bottom: 5px; /* Giảm khoảng cách giữa các hàng */
            gap: 5px; /* Giảm khoảng cách giữa các phím */
        }

        .key {
            background-color: #333;
            color: white;
            border: 1px solid #555;
            padding: 2px 5px; /* Giảm padding */
            border-radius: 4px;
            text-align: center;
            font-size: 12px; /* Giảm kích thước chữ */
            min-width: 0; /* Cho phép co lại */
            flex-grow: 1; /* Rất quan trọng: cho phép tất cả các phím co giãn */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 35px; /* Chiều cao cố định */
            transition: background-color 0.1s, border-color 0.1s;
            cursor: default;
            /* Dùng Flexbox để hiển thị nhãn phím trên 2 dòng (ví dụ: `~` và `1`) */
            flex-direction: column; 
            line-height: 1.1;
        }

        /* Hiệu ứng khi phím được nhấn */
        .key.active {
            background-color: #F6AD55 !important; 
            border-color: #FFD700 !important;
            color: #111 !important;
            box-shadow: 0 0 10px rgba(246, 173, 85, 0.8);
        }

        /* Hiệu ứng sau khi phím đã được nhấn (màu xám) */
        .key.checked {
            background-color: #9b9a9a !important; 
            border-color: #cc4e4e !important;
            color: rgb(38, 0, 255) !important;
        }

        /* Điều chỉnh tỉ lệ cho các phím dài (sử dụng flex-grow) */
        .key.key-tab { flex-grow: 1.5; }
        .key.key-caps { flex-grow: 1.75; }
        .key.key-shift-l { flex-grow: 2.25; }
        .key.key-shift-r { flex-grow: 2.75; }
        .key.key-enter { flex-grow: 2.25; }
        .key.key-backslash { flex-grow: 1.5; }
        .key.key-space { flex-grow: 5; max-width: none; } /* Cho phép space chiếm nhiều không gian hơn */


        /* CSS đặc biệt cho phím Ctrl/Alt */
        .key.key-modifier {
            min-width: 50px;
        }
	</style>
</head>
<body 
    class="bg-[#FBF7F0]"
    
>
<div id="header-placeholder"></div>

<main>
        
        <div id="screen-tester">
            <h1 id="color-name">Nhấn phím Space để bắt đầu kiểm tra (Full Screen)</h1>
            <p id="sub-text" class="text-white text-sm opacity-70">Nhấn ESC hoặc Q để thoát</p>
        </div>
        
        <button id="mode-switcher" style="display:none;">Kiểm tra Loa & Mic</button>
        
        <div id="peripheral-tester" style="display:none;" class="max-w-4xl mx-auto py-12 px-4">
            <h2 class="text-3xl font-bold text-gray-800 text-center mb-10">Công cụ Kiểm tra Loa, Mic & Camera</h2>

            <div id="speaker-tester" class="bg-white p-6 rounded-lg shadow-lg mb-8">
                <h3 class="text-2xl font-semibold mb-4 flex items-center"><i class="fas fa-volume-up mr-3 text-blue-500"></i>Kiểm Tra Loa (Stereo Check)</h3>
                <p class="text-center text-lg mb-4" id="speaker-status">Đảm bảo đã cắm tai nghe hoặc bật loa ngoài. Nhấn START.</p>
                <div class="flex justify-center items-center space-x-6">
                    <button id="start-speaker-check" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded transition duration-300">
                        <i class="fas fa-play mr-2"></i>BẮT ĐẦU
                    </button>
                    <audio id="audio-player"></audio>
                </div>
            </div>
            
            <div id="camera-mic-tester" class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-2xl font-semibold mb-4 flex items-center"><i class="fas fa-video mr-3 text-red-500"></i>Kiểm Tra Mic & Camera</h3>
                <p class="text-center text-lg mb-4" id="camera-mic-status">Vui lòng cho phép dùng camera và mic để kiểm tra. Camera sẽ hiển thị, Mic sẽ hiển thị mức độ âm thanh.</p>
                <div class="flex justify-center mb-6">
                    <button id="start-camera-mic-check" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded transition duration-300">
                        <i class="fas fa-camera mr-2"></i>KIỂM TRA
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <p class="font-medium text-center mb-2">Camera Preview</p>
                        <video id="video-preview" autoplay muted class="w-full bg-gray-200 rounded h-48"></video>
                    </div>
                    <div>
                        <p class="font-medium text-center mb-2">Microphone Level</p>
                        <canvas id="mic-level-canvas" class="w-full bg-gray-200 rounded h-48"></canvas>
                    </div>
                </div>
            </div>
            
            <div id="keyboard-tester" class="mt-12">
                <h3 class="text-2xl font-semibold mb-6 flex items-center"><i class="fas fa-keyboard mr-3 text-yellow-600"></i>Kiểm Tra Bàn Phím (Keyboard Test)</h3>
                <p class="text-center text-lg mb-4" id="keyboard-status">Nhấn bất kỳ phím nào trên bàn phím của bạn để kiểm tra phản hồi.</p>

                <div id="keyboard-layout-container" class="bg-gray-900 p-6 rounded-lg shadow-xl overflow-x-auto">
                    </div>
                
                <div class="mt-4 text-center text-sm text-gray-500">
                    <i class="fas fa-desktop mr-1"></i> Hệ điều hành: <span id="os-display" class="font-bold">Đang nhận diện...</span>
                </div>
            </div>

        </div>
    </main>
    
 <div id="footer-placeholder"></div>

    <script>
        // =========================================================================
        // 1. JAVASCRIPT ĐƯỢC NHÚNG TRỰC TIẾP
        // =========================================================================
        
        // ================== A. SCREEN CHECKER LOGIC ==================

        // --- KHAI BÁO BIẾN CHO MÀN HÌNH ---
        const colors = [
            { name: "ĐEN", hex: "#000000" },
            { name: "TRẮNG", hex: "#FFFFFF" },
            { name: "ĐỎ", hex: "#FF0000" },
            { name: "XANH LÁ", hex: "#00FF00" },
            { name: "XANH DƯƠNG", hex: "#0000FF" },
            { name: "VÀNG", hex: "#FFFF00" },
            { name: "TÍM", hex: "#FF00FF" },
            { name: "XÁM", hex: "#808080" }
        ];

        let currentIndex = -1;
        const screenTester = document.getElementById('screen-tester');
        const colorNameDisplay = document.getElementById('color-name');
        const subText = document.getElementById('sub-text');
        let isFirstInteraction = true; 


        // 1. HÀM THỰC HIỆN TOÀN MÀN HÌNH (toggleFullscreen)
        function toggleFullscreen() {
            const body = document.body;
            if (!document.fullscreenElement) {
                // Yêu cầu chế độ toàn màn hình cho phần tử body (bao trùm tất cả)
                if (body.requestFullscreen) {
                    body.requestFullscreen();
                } else if (body.webkitRequestFullscreen) {
                    body.webkitRequestFullscreen();
                } else if (body.msRequestFullscreen) {
                    body.msRequestFullscreen();
                }
                subText.style.display = 'block';
                // Ẩn nút chuyển chế độ khi vào Fullscreen
                modeSwitcher.style.display = 'none'; 
            } else {
                // Thoát chế độ toàn màn hình 
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                subText.style.display = 'none'; 
                // Hiển thị lại nút chuyển chế độ khi thoát Fullscreen
                modeSwitcher.style.display = 'block'; 
            }
        }

        // Tự động ẩn subtext ban đầu
        subText.style.display = 'none';

        // Xử lý sự kiện khi Fullscreen thay đổi (dùng để đặt lại trạng thái)
        document.addEventListener('fullscreenchange', (event) => {
            if (!document.fullscreenElement) {
                // Nếu thoát Fullscreen (bằng ESC), đưa màn hình về trạng thái ban đầu
                screenTester.style.backgroundColor = '#333';
                colorNameDisplay.textContent = 'Bấm hoặc nhấn Space để bắt đầu kiểm tra (Full Screen)';
                screenTester.classList.remove('hide-text');
                isFirstInteraction = true; // Cho phép vào lại Fullscreen
                subText.style.display = 'none';
                // Đảm bảo nút chuyển chế độ hiện ra sau khi ESC
                modeSwitcher.style.display = 'block'; 
            }
        });


        // 2. HÀM CHUYỂN MÀU (changeColor)
        function changeColor() {
            // KÍCH HOẠT TOÀN MÀN HÌNH TẠI ĐÂY (Trong tương tác đầu tiên)
            if (isFirstInteraction) {
                toggleFullscreen();
                isFirstInteraction = false;
            }

            // Đảm bảo chỉ thay đổi màu khi đang ở chế độ kiểm tra màn hình
            if (screenTester.style.display === 'none' && !document.fullscreenElement) return;

            currentIndex = (currentIndex + 1) % colors.length; 
            const currentColor = colors[currentIndex];

            // Cập nhật giao diện
            screenTester.style.backgroundColor = currentColor.hex;
            colorNameDisplay.textContent = currentColor.name;

            // Điều chỉnh màu chữ
            if (currentColor.hex === "#FFFFFF") {
                colorNameDisplay.style.color = "black";
            } else {
                colorNameDisplay.style.color = "white";
            }

            // Ẩn chữ khi ở chế độ Đen, Trắng, Xám
            if (currentColor.hex === "#000000" || currentColor.hex === "#FFFFFF" || currentColor.hex === "#808080") {
                screenTester.classList.add('hide-text');
                subText.style.display = 'none';
            } else {
                screenTester.classList.remove('hide-text');
                subText.style.display = 'block';
            }
        }


        // 3. SỰ KIỆN LẮNG NGHE (MÀN HÌNH)
        screenTester.addEventListener('click', changeColor);

        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' || e.code === 'Enter') {
                e.preventDefault();
                // Chỉ chuyển màu nếu đang ở chế độ kiểm tra màn hình
                if (screenTester.style.display !== 'none') {
                    changeColor();
                }
            }
            // Dùng phím 'Q' để thoát Fullscreen thủ công (hoặc ESC tự động)
            if (e.code === 'KeyQ' && document.fullscreenElement) {
                toggleFullscreen();
            }
        });

        // ================== B. SPEAKER CHECKER LOGIC ==================

        // --- KHAI BÁO BIẾN CHO LOA ---
        const peripheralTester = document.getElementById('peripheral-tester');
        const audioPlayer = document.getElementById('audio-player');
        const speakerStatus = document.getElementById('speaker-status');
        const startSpeakerButton = document.getElementById('start-speaker-check');
        const modeSwitcher = document.getElementById('mode-switcher');

        // Danh sách các tệp âm thanh cần phát theo thứ tự
        const audioSources = [
            { src: '/file/mp3/left_speaker.mp3', status: 'Đang phát: LOA TRÁI (LEFT) - Nghe kỹ.' },
            { src: '/file/mp3/right_speakermp3', status: 'Đang phát: LOA PHẢI (RIGHT) - Nghe kỹ.' }
        ];

        let audioIndex = 0;

        // HÀM CHUYỂN CHẾ ĐỘ (Màu <-> Thiết bị ngoại vi)
        modeSwitcher.addEventListener('click', () => {
            if (screenTester.style.display !== 'none') {
                // Chuyển sang chế độ Thiết bị ngoại vi
                screenTester.style.display = 'none';
                peripheralTester.style.display = 'block';
                modeSwitcher.textContent = 'Chuyển sang Kiểm tra Màn hình';
            } else {
                // Chuyển sang chế độ Màn hình
                peripheralTester.style.display = 'none';
                screenTester.style.display = 'flex';
                modeSwitcher.textContent = 'Chuyển sang Kiểm tra Loa & Mic';
            }
            
            // Tắt fullscreen nếu đang mở
            if (document.fullscreenElement) {
                toggleFullscreen();
            }
        });

        // Hiện nút chuyển chế độ sau khi trang tải xong
        document.addEventListener('DOMContentLoaded', () => {
             // Chỉ hiển thị nút chuyển chế độ nếu đang ở chế độ kiểm tra màn hình ban đầu
            if (screenTester.style.display !== 'none') {
                 modeSwitcher.style.display = 'block';
            }
        });

        // HÀM PHÁT ÂM THANH THEO THỨ TỰ
        function playNextAudio() {
            if (audioIndex < audioSources.length) {
                const currentAudio = audioSources[audioIndex];
                
                speakerStatus.textContent = currentAudio.status;
                
                audioPlayer.src = currentAudio.src;
                audioPlayer.play().catch(error => {
                    speakerStatus.textContent = 'BỊ CHẶN: Vui lòng click lại nút START (Trình duyệt chặn Auto-Play)';
                    console.error("Lỗi phát âm thanh:", error);
                });

                audioIndex++;
            } else {
                speakerStatus.textContent = 'Đã hoàn thành kiểm tra loa. Vui lòng nhấn START để kiểm tra lại.';
                startSpeakerButton.disabled = false; 
                audioIndex = 0; 
            }
        }

        // SỰ KIỆN KHI ÂM THANH KẾT THÚC
        audioPlayer.addEventListener('ended', playNextAudio);

        // SỰ KIỆN CLICK NÚT START
        startSpeakerButton.addEventListener('click', () => {
            startSpeakerButton.disabled = true; 
            audioIndex = 0; 
            playNextAudio();
        });


        // ================== C. CAMERA/MIC CHECKER LOGIC ==================

        const startCameraMicButton = document.getElementById('start-camera-mic-check');
        const videoPreview = document.getElementById('video-preview');
        const micLevelCanvas = document.getElementById('mic-level-canvas');
        const canvasCtx = micLevelCanvas.getContext('2d');
        const cameraMicStatus = document.getElementById('camera-mic-status');
        let animationFrame;

        startCameraMicButton.addEventListener('click', () => {
            startCameraMicButton.disabled = true;
            cameraMicStatus.textContent = 'Đang yêu cầu cấp quyền...';
            
            // Yêu cầu truy cập Mic và Camera
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(stream => {
                    cameraMicStatus.textContent = 'Đã cấp quyền. Camera và Mic đang hoạt động.';

                    // 1. Camera
                    videoPreview.srcObject = stream;
                    
                    // 2. Microphone (Hiển thị mức độ âm thanh)
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const analyser = audioContext.createAnalyser();
                    const microphone = audioContext.createMediaStreamSource(stream);
                    
                    microphone.connect(analyser);
                    analyser.fftSize = 256;
                    const bufferLength = analyser.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLength);
                    
                    function draw() {
                        canvasCtx.clearRect(0, 0, micLevelCanvas.width, micLevelCanvas.height);
                        
                        analyser.getByteFrequencyData(dataArray);

                        let sum = 0;
                        for (let i = 0; i < bufferLength; i++) {
                            sum += dataArray[i];
                        }
                        const average = sum / bufferLength;
                        
                        const barHeight = average * 1.5; 
                        const finalHeight = Math.min(barHeight, micLevelCanvas.height);

                        canvasCtx.fillStyle = '#C0392B'; 
                        canvasCtx.fillRect(0, micLevelCanvas.height - finalHeight, micLevelCanvas.width, finalHeight);
                        
                        animationFrame = requestAnimationFrame(draw);
                    }
                    draw();
                })
                .catch(err => {
                    cameraMicStatus.textContent = `LỖI TRUY CẬP: ${err.name}. Vui lòng kiểm tra quyền truy cập Camera/Mic.`;
                    startCameraMicButton.disabled = false;
                });
        });
        // ================== D. KEYBOARD CHECKER LOGIC ==================

        const keyboardLayoutContainer = document.getElementById('keyboard-layout-container');
        const osDisplay = document.getElementById('os-display');

        
        // Định nghĩa mã phím (key codes) và nhãn hiển thị cho 2 HĐH
        // SỬ DỤNG MÃ `e.code` (Code) vì nó độc lập với layout ngôn ngữ
        const KEY_LAYOUTS = {
            // Layout cho Windows
            windows: [
                ['Escape', 'F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8', 'F9', 'F10', 'F11', 'F12', 'PrintScreen', 'ScrollLock', 'Pause', 'Home', 'End'],
                ['Backquote', 'Digit1', 'Digit2', 'Digit3', 'Digit4', 'Digit5', 'Digit6', 'Digit7', 'Digit8', 'Digit9', 'Digit0', 'Minus', 'Equal', 'Backspace', 'NumLock', 'NumpadDivide', 'NumpadMultiply', 'NumpadSubtract', 'NumpadAdd'],
                ['Tab', 'KeyQ', 'KeyW', 'KeyE', 'KeyR', 'KeyT', 'KeyY', 'KeyU', 'KeyI', 'KeyO', 'KeyP', 'BracketLeft', 'BracketRight', 'Backslash', '','Numpad7', 'Numpad8', 'Numpad9'],
                ['CapsLock', 'KeyA', 'KeyS', 'KeyD', 'KeyF', 'KeyG', 'KeyH', 'KeyJ', 'KeyK', 'KeyL', 'Semicolon', 'Quote', 'Enter', '','Numpad4', 'Numpad5', 'Numpad6'],
                ['ShiftLeft', 'KeyZ', 'KeyX', 'KeyC', 'KeyV', 'KeyB', 'KeyN', 'KeyM', 'Comma', 'Period', 'Slash', 'ShiftRight', '','Numpad1', 'Numpad2', 'Numpad3'],
                ['ControlLeft', 'MetaLeft', 'AltLeft', 'Space', 'AltRight', 'ContextMenu', 'ControlRight', 'ArrowUp', '','Numpad0', 'NumpadDecimal', 'NumpadEnter'],
                ['', '', '', '', '', '', '','', '','', '','', '', '', 'ArrowLeft', 'ArrowDown', 'ArrowRight','','', '','',''] // Hàng cuối cho các phím mũi tên
            ],
            // Layout cho macOS
            macos: [
                ['Escape', 'F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8', 'F9', 'F10', 'F11', 'F12', 'VolumeUp', 'VolumeDown', 'Mute', 'PlayPause', 'Eject'], // Giả định một số phím chức năng Mac
                ['Backquote', 'Digit1', 'Digit2', 'Digit3', 'Digit4', 'Digit5', 'Digit6', 'Digit7', 'Digit8', 'Digit9', 'Digit0', 'Minus', 'Equal', 'Backspace'],
                ['Tab', 'KeyQ', 'KeyW', 'KeyE', 'KeyR', 'KeyT', 'KeyY', 'KeyU', 'KeyI', 'KeyO', 'KeyP', 'BracketLeft', 'BracketRight', 'Backslash'],
                ['CapsLock', 'KeyA', 'KeyS', 'KeyD', 'KeyF', 'KeyG', 'KeyH', 'KeyJ', 'KeyK', 'KeyL', 'Semicolon', 'Quote', 'Enter'],
                ['ShiftLeft', 'KeyZ', 'KeyX', 'KeyC', 'KeyV', 'KeyB', 'KeyN', 'KeyM', 'Comma', 'Period', 'Slash', 'ShiftRight', 'ArrowUp', ''],
                ['ControlLeft', 'AltLeft', 'MetaLeft', 'Space', 'MetaRight', 'AltRight', 'ControlRight', 'ArrowLeft', 'ArrowDown', 'ArrowRight'],
                ['', '', '', '']
            ]
        };

        // Ánh xạ Mã phím (e.code) sang Nhãn hiển thị (Label)
        const KEY_LABELS = {
            'Escape': 'Esc', 'Tab': 'Tab', 'CapsLock': 'Caps', 'ShiftLeft': 'Shift', 'ShiftRight': 'Shift',
            'ControlLeft': 'Ctrl', 'ControlRight': 'Ctrl', 'AltLeft': 'Alt', 'AltRight': 'Alt',
            'MetaLeft': '⌘/Win', 'MetaRight': '⌘/Win', 'Space': 'Space', 'Enter': 'Enter',
            'Backspace': 'Delete', 'Backquote': '` ~', 'Minus': '- _', 'Equal': '= +',
            'BracketLeft': '[ {', 'BracketRight': '] }', 'Backslash': '\\ |', 'Semicolon': '; :',
            'Quote': `' "`, 'Comma': ', <', 'Period': '. >', 'Slash': '/ ?',
            'Digit1': '1 !', 'Digit2': '2 @', /*... cứ thế cho các phím số ...*/
            'PrintScreen': 'PrtSc', 'ScrollLock': 'ScrLk', 'Pause': 'Pause', 'Insert': 'Ins', 'Delete': 'Del',
            'ArrowUp': '↑', 'ArrowDown': '↓', 'ArrowLeft': '←', 'ArrowRight': '→',
            'ContextMenu': 'Menu', 'NumpadDivide': '/', 'NumpadMultiply': '*', 'NumpadSubtract': '-',
            'NumpadAdd': '+', 'NumpadDecimal': '.', 'NumpadEnter': 'Enter',
            // Nhãn đơn giản cho các phím chữ cái
            'KeyA': 'A', 'KeyB': 'B', 'KeyC': 'C', 'KeyD': 'D', 'KeyE': 'E', 'KeyF': 'F',
            // ... thêm tất cả các phím chữ cái khác
        };
        // Tự động thêm nhãn cho các phím F và Digit còn lại (ví dụ)
        for (let i = 1; i <= 12; i++) { KEY_LABELS[`F${i}`] = `F${i}`; }
        for (let i = 0; i <= 9; i++) { KEY_LABELS[`Digit${i}`] = i; }
        for (let i = 0; i <= 9; i++) { KEY_LABELS[`Numpad${i}`] = i; }


        // 1. Nhận diện Hệ điều hành
        function detectOS() {
            const userAgent = window.navigator.userAgent.toLowerCase();
            if (userAgent.indexOf('mac') > -1) {
                return 'macos';
            }
            if (userAgent.indexOf('win') > -1) {
                return 'windows';
            }
            return 'windows'; // Mặc định là windows nếu không nhận diện được
        }
        const currentOS = detectOS();
        osDisplay.textContent = currentOS === 'macos' ? 'macOS (Apple)' : 'Windows';


        // 2. Xây dựng Layout bàn phím dựa trên OS
        function buildKeyboardLayout(os) {
            const layout = KEY_LAYOUTS[os];
            keyboardLayoutContainer.innerHTML = ''; // Xóa layout cũ

            layout.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'key-row';
                
                row.forEach(keyCode => {
                    if (!keyCode) { // Xử lý khoảng trống (nếu có)
                        const spacer = document.createElement('div');
                        spacer.style.width = '30px'; 
                        rowDiv.appendChild(spacer);
                        return;
                    }

                    const keyDiv = document.createElement('div');
                    keyDiv.className = 'key';
                    keyDiv.id = `key-${keyCode}`; // ID quan trọng để xử lý sự kiện
                    keyDiv.textContent = KEY_LABELS[keyCode] || keyCode.replace('Key', ''); // Hiển thị nhãn

                    // Thêm class đặc biệt cho các phím dài/đặc biệt
                    if (keyCode === 'Tab') keyDiv.classList.add('key-tab');
                    if (keyCode === 'CapsLock') keyDiv.classList.add('key-caps');
                    if (keyCode === 'ShiftLeft') keyDiv.classList.add('key-shift-l');
                    if (keyCode === 'ShiftRight') keyDiv.classList.add('key-shift-r');
                    if (keyCode === 'Enter') keyDiv.classList.add('key-enter');
                    if (keyCode === 'Space') keyDiv.classList.add('key-space');
                    if (['ControlLeft', 'ControlRight', 'AltLeft', 'AltRight', 'MetaLeft', 'MetaRight'].includes(keyCode)) {
                        keyDiv.classList.add('key-modifier');
                    }
                    
                    rowDiv.appendChild(keyDiv);
                });
                
                keyboardLayoutContainer.appendChild(rowDiv);
            });
        }

        // Gọi hàm xây dựng layout khi tải trang
        buildKeyboardLayout(currentOS);

        // ... (Tiếp tục trong thẻ <script> của bạn)

        // ================== E. KEYBOARD EVENT HANDLERS ==================

        // Xử lý khi nhấn phím (KeyDown)
    document.addEventListener('keydown', (e) => {
        // ... (Logic chuyển màu giữ nguyên) ...

        // 2. Logic cho Key Test (Nếu đang ở chế độ kiểm tra thiết bị)
        if (peripheralTester.style.display !== 'none') {
            const targetKey = document.getElementById(`key-${e.code}`);
            if (targetKey) {
                e.preventDefault(); 
                // 💡 1. Khi nhấn: BẬT màu active (CAM)
                targetKey.classList.add('active');
                targetKey.classList.remove('checked'); // Đảm bảo lớp checked bị xóa
            }
        }
    });

    // Xử lý khi nhả phím (KeyUp)
    document.addEventListener('keyup', (e) => {
        if (peripheralTester.style.display !== 'none') {
            const targetKey = document.getElementById(`key-${e.code}`);
            if (targetKey) {
                // 💡 2. Khi nhả: TẮT active và BẬT checked (XÁM)
                targetKey.classList.remove('active');
                targetKey.classList.add('checked');
            }
        }
    });


    // 3. Hàm Reset Bàn phím
    function resetKeyboard() {
        const checkedKeys = keyboardLayoutContainer.querySelectorAll('.key.checked, .key.active');
        checkedKeys.forEach(key => {
            key.classList.remove('checked');
            key.classList.remove('active');
        });
        document.getElementById('keyboard-status').textContent = 'Nhấn bất kỳ phím nào trên bàn phím của bạn để kiểm tra phản hồi.';
    }

    // 4. Sự kiện Reset
    resetKeyboardBtn.addEventListener('click', resetKeyboard);


        // =========================================================================
        // 2. CODE CỦA BẠN (Dùng cho header/footer/logic phân trang)
        // (Giữ lại các thẻ script src cũ để đảm bảo logic header/footer hoạt động)
        // =========================================================================

    </script>
    <script src="/js/script.js"></script>
    <script src="/js/content.js"></script>
    <script src="/pages/page-logic.js"></script>
</body>
</html>